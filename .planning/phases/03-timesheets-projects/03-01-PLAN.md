---
phase: 03-timesheets-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/timesheets/dto/create-timesheet.dto.ts
  - apps/api/src/timesheets/dto/update-timesheet.dto.ts
  - apps/api/src/timesheets/timesheets.service.ts
  - apps/api/src/timesheets/timesheets.controller.ts
autonomous: true

must_haves:
  truths:
    - "User can create timesheet entry with project selection"
    - "User can create timesheet entry with optional task selection"
    - "System rejects entries exceeding 24 hours/day"
    - "User can attach files to timesheet entries"
    - "User can only edit/delete same-day entries"
  artifacts:
    - path: "apps/api/src/timesheets/dto/create-timesheet.dto.ts"
      provides: "Timesheet DTO with optional taskId and attachmentKeys"
      contains: "attachmentKeys"
    - path: "apps/api/src/timesheets/timesheets.service.ts"
      provides: "Timesheet CRUD with attachment linking"
      exports: ["TimesheetsService"]
  key_links:
    - from: "apps/api/src/timesheets/timesheets.service.ts"
      to: "prisma.timesheetEntry"
      via: "Prisma create/update with attachment linking"
      pattern: "timesheetAttachment.createMany"
---

<objective>
Enhance the existing timesheets API to support optional task selection, file attachments, and same-day edit restriction.

Purpose: Enable users to log hours with flexible project/task selection and attach supporting files.
Output: Enhanced timesheet API with full CRUD, attachments, and validation.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-timesheets-projects/03-CONTEXT.md
@.planning/phases/03-timesheets-projects/03-RESEARCH.md

@apps/api/src/timesheets/timesheets.service.ts
@apps/api/src/timesheets/timesheets.controller.ts
@apps/api/src/timesheets/dto/create-timesheet.dto.ts
@apps/api/src/storage/storage.service.ts
@apps/api/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update DTOs for optional task and attachments</name>
  <files>
    apps/api/src/timesheets/dto/create-timesheet.dto.ts
    apps/api/src/timesheets/dto/update-timesheet.dto.ts
  </files>
  <action>
Update CreateTimesheetDto:
1. Make `taskId` optional with `@IsOptional()` decorator
2. Add `attachmentKeys?: string[]` field (array of MinIO object keys)
3. Add `startTime` and `endTime` fields (ISO datetime strings)
4. Remove `minutes` field - calculate from start/end times

Update UpdateTimesheetDto:
1. Mirror optional fields from CreateTimesheetDto
2. Include attachmentKeys for adding/removing attachments

Per CONTEXT.md: Entry uses start/end time pickers, duration calculated automatically.
  </action>
  <verify>
Run `npm run build --workspace=apps/api` - no TypeScript errors
  </verify>
  <done>DTOs accept optional taskId, attachmentKeys array, and start/end times</done>
</task>

<task type="auto">
  <name>Task 2: Enhance timesheet service with attachments and restrictions</name>
  <files>apps/api/src/timesheets/timesheets.service.ts</files>
  <action>
Update TimesheetsService:

1. **create()** method:
   - Calculate minutes from startTime/endTime (date-fns differenceInMinutes)
   - Make task validation conditional (only if taskId provided)
   - After entry creation, link attachments via TimesheetAttachment model
   - Use: `this.prisma.timesheetAttachment.createMany({ data: attachmentKeys.map(...) })`

2. **update()** method:
   - Add same-day check: compare entry.date with today (server timezone)
   - Return 400 "Can only edit today's entries" if not same day
   - Handle attachment updates (add new keys, could remove old if not in new list)
   - Recalculate minutes if start/end times changed

3. **remove()** method:
   - Add same-day check before deletion
   - Delete associated attachments (cascade should handle, but verify)

4. **findAll()** method:
   - Include attachments in response with download URLs
   - Add helper to generate presigned download URLs (inject StorageService)

Storage integration:
- Import StorageService from '../storage/storage.service'
- Use getDownloadUrl() for attachment URLs in responses
  </action>
  <verify>
Run `npm run build --workspace=apps/api` - no TypeScript errors
Run `npm run lint --workspace=apps/api` - no lint errors
  </verify>
  <done>
- Entry creates with calculated minutes from start/end
- Attachments linked after entry creation
- Edit/delete blocked for non-today entries
- Attachment URLs included in responses
  </done>
</task>

<task type="auto">
  <name>Task 3: Update controller and add attachment URL endpoint</name>
  <files>apps/api/src/timesheets/timesheets.controller.ts</files>
  <action>
Update TimesheetsController:

1. **create()** - Works as-is with updated DTO (no changes needed if using DTO)

2. **findOne()** - Add endpoint to get single entry with attachments:
   ```typescript
   @Get(':id')
   @ApiOperation({ summary: 'Get single timesheet entry' })
   async findOne(@Param('id') id: string, @CurrentUser() user: any) {
     return this.timesheetsService.findOne(id, user.id);
   }
   ```

3. **getAttachmentUrl()** - Add endpoint for download URL:
   ```typescript
   @Get('attachment/:objectKey(*)')
   @ApiOperation({ summary: 'Get presigned download URL for attachment' })
   async getAttachmentUrl(
     @Param('objectKey') objectKey: string,
     @CurrentUser() user: any,
   ) {
     // Verify user owns the timesheet entry containing this attachment
     const url = await this.timesheetsService.getAttachmentDownloadUrl(objectKey, user.id);
     return { success: true, data: { url } };
   }
   ```

4. Add `findOne()` and `getAttachmentDownloadUrl()` methods to service:
   - findOne(): Get entry by ID with user ownership check
   - getAttachmentDownloadUrl(): Verify ownership, return presigned URL
  </action>
  <verify>
Run `npm run build --workspace=apps/api`
Start API: `npm run dev --workspace=apps/api`
Test: `curl -X GET http://localhost:3001/timesheets/projects -H "Authorization: Bearer <token>"` returns projects
  </verify>
  <done>
- GET /timesheets/:id returns single entry
- GET /timesheets/attachment/:key returns presigned download URL
- Ownership verified before returning attachment URLs
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build --workspace=apps/api`
2. Manual test via Swagger UI or curl:
   - Create entry with only projectId (no taskId) - should succeed
   - Create entry with taskId - should succeed
   - Create entry exceeding 24h/day - should fail with 400
   - Edit yesterday's entry - should fail with 400
   - Get entry with attachments - should include download URLs
</verification>

<success_criteria>
- CreateTimesheetDto accepts optional taskId and attachmentKeys
- Service calculates minutes from start/end times
- Attachments linked to entries in database
- Same-day restriction enforced for edit/delete
- API returns presigned download URLs for attachments
</success_criteria>

<output>
After completion, create `.planning/phases/03-timesheets-projects/03-01-SUMMARY.md`
</output>
