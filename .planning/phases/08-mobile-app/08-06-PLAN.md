---
phase: 08-mobile-app
plan: 06
type: execute
wave: 4
depends_on: ["08-02", "08-03", "08-04", "08-05"]
files_modified:
  - apps/mobile/src/lib/offline.ts
  - apps/mobile/src/components/common/NetworkBanner.tsx
  - apps/mobile/src/components/common/OfflineIndicator.tsx
  - apps/mobile/app/_layout.tsx
  - apps/mobile/app/(tabs)/profile.tsx
autonomous: false

must_haves:
  truths:
    - "App works offline for viewing cached data"
    - "Network status indicator visible when offline"
    - "User can log out from profile"
    - "All tabs function with real data"
  artifacts:
    - path: "apps/mobile/src/lib/offline.ts"
      provides: "Network status hook and offline utilities"
      exports: ["useNetworkStatus", "useIsOnline"]
    - path: "apps/mobile/src/components/common/NetworkBanner.tsx"
      provides: "Offline banner shown when disconnected"
    - path: "apps/mobile/app/(tabs)/profile.tsx"
      provides: "Profile screen with logout"
  key_links:
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/src/components/common/NetworkBanner.tsx"
      via: "conditional render"
      pattern: "NetworkBanner"
---

<objective>
Complete mobile app with offline support, network indicators, and integration verification.

Purpose: Finalize the mobile app with offline viewing capability and verify all features work together.
Output: Complete mobile app with offline indicator, profile screen, and verified end-to-end functionality.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-mobile-app/08-RESEARCH.md

# Prior plan summaries
@.planning/phases/08-mobile-app/08-01-SUMMARY.md
@.planning/phases/08-mobile-app/08-02-SUMMARY.md
@.planning/phases/08-mobile-app/08-03-SUMMARY.md
@.planning/phases/08-mobile-app/08-04-SUMMARY.md
@.planning/phases/08-mobile-app/08-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create offline utilities and network banner</name>
  <files>
    apps/mobile/src/lib/offline.ts
    apps/mobile/src/components/common/NetworkBanner.tsx
    apps/mobile/src/components/common/OfflineIndicator.tsx
  </files>
  <action>
**1. Create/update `apps/mobile/src/lib/offline.ts`:**

Network status utilities:

```typescript
import { useState, useEffect } from 'react';
import NetInfo, { NetInfoState } from '@react-native-community/netinfo';

// Hook for full network state
export function useNetworkStatus() {
  const [networkState, setNetworkState] = useState<NetInfoState | null>(null);

  useEffect(() => {
    // Get initial state
    NetInfo.fetch().then(setNetworkState);

    // Subscribe to changes
    const unsubscribe = NetInfo.addEventListener(setNetworkState);
    return () => unsubscribe();
  }, []);

  return {
    isConnected: networkState?.isConnected ?? true,
    isInternetReachable: networkState?.isInternetReachable ?? true,
    type: networkState?.type,
    details: networkState?.details,
  };
}

// Simple boolean hook
export function useIsOnline(): boolean {
  const { isConnected, isInternetReachable } = useNetworkStatus();
  return isConnected && isInternetReachable !== false;
}
```

**2. Create `apps/mobile/src/components/common/NetworkBanner.tsx`:**

Banner shown when offline:

```typescript
import { View, Text, StyleSheet } from 'react-native';
import Animated, { FadeInDown, FadeOutUp } from 'react-native-reanimated';
import { WifiOff } from 'lucide-react-native';
import { colors, typography } from '../../theme';
import { useIsOnline } from '../../lib/offline';

export function NetworkBanner() {
  const isOnline = useIsOnline();

  if (isOnline) return null;

  return (
    <Animated.View
      entering={FadeInDown.duration(300)}
      exiting={FadeOutUp.duration(300)}
      style={styles.banner}
    >
      <WifiOff size={16} color="#FFFFFF" />
      <Text style={styles.text}>No internet connection</Text>
    </Animated.View>
  );
}

const styles = StyleSheet.create({
  banner: {
    backgroundColor: colors.semantic.warning,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: 8,
    paddingVertical: 8,
    paddingHorizontal: 16,
  },
  text: {
    color: '#FFFFFF',
    fontSize: typography.fontSize.sm,
    fontWeight: '500',
  },
});
```

**3. Create `apps/mobile/src/components/common/OfflineIndicator.tsx`:**

Small indicator for individual screens:

```typescript
import { View, Text, StyleSheet } from 'react-native';
import { Cloud, CloudOff } from 'lucide-react-native';
import { colors, typography } from '../../theme';
import { useIsOnline } from '../../lib/offline';

interface Props {
  showWhenOnline?: boolean;
}

export function OfflineIndicator({ showWhenOnline = false }: Props) {
  const isOnline = useIsOnline();

  if (isOnline && !showWhenOnline) return null;

  return (
    <View style={[styles.container, !isOnline && styles.offline]}>
      {isOnline ? (
        <Cloud size={14} color={colors.semantic.success} />
      ) : (
        <CloudOff size={14} color={colors.semantic.warning} />
      )}
      <Text style={[styles.text, !isOnline && styles.offlineText]}>
        {isOnline ? 'Online' : 'Offline'}
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    backgroundColor: colors.silver[100],
  },
  offline: {
    backgroundColor: colors.semantic.warning + '20',
  },
  text: {
    fontSize: typography.fontSize.xs,
    color: colors.semantic.success,
  },
  offlineText: {
    color: colors.semantic.warning,
  },
});
```
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Components export correctly.
  </verify>
  <done>
Offline utilities and network status components created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add NetworkBanner to root layout and create profile screen</name>
  <files>
    apps/mobile/app/_layout.tsx
    apps/mobile/app/(tabs)/profile.tsx
  </files>
  <action>
**1. Update `apps/mobile/app/_layout.tsx`:**

Add NetworkBanner to show when offline:

- Import `NetworkBanner` from `../src/components/common/NetworkBanner`
- Add `<NetworkBanner />` inside the GestureHandlerRootView, above Stack:

```tsx
<GestureHandlerRootView style={{ flex: 1 }}>
  <PersistQueryClientProvider ...>
    <NetworkBanner />
    <StatusBar style="auto" />
    <Stack ...>
      ...
    </Stack>
  </PersistQueryClientProvider>
</GestureHandlerRootView>
```

The banner will auto-show/hide based on network state.

**2. Update `apps/mobile/app/(tabs)/profile.tsx`:**

Create profile screen with user info and logout:

```tsx
import { View, Text, TouchableOpacity, StyleSheet, Alert } from 'react-native';
import { router } from 'expo-router';
import { User, LogOut, ChevronRight, Bell, Shield, HelpCircle } from 'lucide-react-native';
import { useAuthStore } from '../../src/store/auth';
import { colors, typography, borderRadius, shadows, spacing } from '../../src/theme';
import { OfflineIndicator } from '../../src/components/common/OfflineIndicator';

export default function ProfileScreen() {
  const { user, logout } = useAuthStore();

  const handleLogout = () => {
    Alert.alert(
      'Logout',
      'Are you sure you want to log out?',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Logout',
          style: 'destructive',
          onPress: async () => {
            await logout();
            router.replace('/login');
          },
        },
      ]
    );
  };

  return (
    <View style={styles.container}>
      {/* User Info Card */}
      <View style={styles.userCard}>
        <View style={styles.avatar}>
          <Text style={styles.avatarText}>
            {user?.profile?.firstName?.[0]}{user?.profile?.lastName?.[0]}
          </Text>
        </View>
        <Text style={styles.userName}>
          {user?.profile?.firstName} {user?.profile?.lastName}
        </Text>
        <Text style={styles.userEmail}>{user?.email}</Text>
        <Text style={styles.userRole}>{user?.role}</Text>
        <OfflineIndicator showWhenOnline />
      </View>

      {/* Menu Items */}
      <View style={styles.menuSection}>
        <TouchableOpacity style={styles.menuItem}>
          <Bell size={20} color={colors.navy[700]} />
          <Text style={styles.menuText}>Notifications</Text>
          <ChevronRight size={20} color={colors.silver[400]} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <Shield size={20} color={colors.navy[700]} />
          <Text style={styles.menuText}>Privacy & Security</Text>
          <ChevronRight size={20} color={colors.silver[400]} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <HelpCircle size={20} color={colors.navy[700]} />
          <Text style={styles.menuText}>Help & Support</Text>
          <ChevronRight size={20} color={colors.silver[400]} />
        </TouchableOpacity>
      </View>

      {/* Logout Button */}
      <TouchableOpacity style={styles.logoutButton} onPress={handleLogout}>
        <LogOut size={20} color={colors.semantic.error} />
        <Text style={styles.logoutText}>Logout</Text>
      </TouchableOpacity>

      {/* App Version */}
      <Text style={styles.version}>Version 1.0.0</Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.silver[50],
    padding: spacing[4],
  },
  userCard: {
    backgroundColor: '#FFFFFF',
    borderRadius: borderRadius['2xl'],
    padding: spacing[6],
    alignItems: 'center',
    marginBottom: spacing[4],
    ...shadows.md,
  },
  avatar: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: colors.blue[600],
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: spacing[3],
  },
  avatarText: {
    fontSize: typography.fontSize['2xl'],
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  userName: {
    fontSize: typography.fontSize.xl,
    fontWeight: '600',
    color: colors.navy[900],
  },
  userEmail: {
    fontSize: typography.fontSize.sm,
    color: colors.silver[500],
    marginTop: spacing[1],
  },
  userRole: {
    fontSize: typography.fontSize.xs,
    color: colors.blue[600],
    backgroundColor: colors.blue[100],
    paddingHorizontal: spacing[3],
    paddingVertical: spacing[1],
    borderRadius: borderRadius.full,
    marginTop: spacing[2],
    textTransform: 'uppercase',
  },
  menuSection: {
    backgroundColor: '#FFFFFF',
    borderRadius: borderRadius.xl,
    overflow: 'hidden',
    marginBottom: spacing[4],
    ...shadows.sm,
  },
  menuItem: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: spacing[4],
    borderBottomWidth: 1,
    borderBottomColor: colors.silver[100],
    gap: spacing[3],
  },
  menuText: {
    flex: 1,
    fontSize: typography.fontSize.base,
    color: colors.navy[900],
  },
  logoutButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: spacing[2],
    backgroundColor: colors.semantic.error + '10',
    padding: spacing[4],
    borderRadius: borderRadius.xl,
    marginBottom: spacing[4],
  },
  logoutText: {
    fontSize: typography.fontSize.base,
    fontWeight: '600',
    color: colors.semantic.error,
  },
  version: {
    textAlign: 'center',
    fontSize: typography.fontSize.xs,
    color: colors.silver[400],
  },
});
```
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
NetworkBanner shows in root layout.
Profile screen has logout functionality.
  </verify>
  <done>
NetworkBanner integrated into app layout.
Profile screen shows user info and logout.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete mobile app with:
- Authentication (login with session persistence)
- Attendance (check-in/out with GPS capture)
- Timesheets (entry creation with project/task selection)
- Team presence (real-time status via WebSocket)
- Chat (1:1 and group messaging)
- Offline support (cached data viewing)
- Network status indicator
- Profile with logout
  </what-built>
  <how-to-verify>
1. Start the API and mobile app:
   ```bash
   # Terminal 1: API
   cd apps/api && npm run start:dev

   # Terminal 2: Mobile (in Expo Go or simulator)
   cd apps/mobile && npm start
   ```

2. Test Login (MOBL-01):
   - Open app, should redirect to login
   - Login with admin@satcom.com / Password123!
   - Should navigate to dashboard
   - Close and reopen app - should still be logged in (session persistence)

3. Test Attendance (MOBL-02, MOBL-06):
   - On dashboard, tap "Check In"
   - Should see location permission explanation dialog
   - Allow location
   - Select work mode and check in
   - Should see checked-in status with time
   - Test "Check Out" - should show summary

4. Test Timesheets (MOBL-03):
   - Navigate to Timesheet tab
   - Tap "Add New"
   - Select project and task
   - Enter hours and notes
   - Submit entry
   - Should appear in entries list

5. Test Team Presence (MOBL-04):
   - Navigate to Team tab
   - Should see team members with status indicators
   - Test status filter pills
   - Verify "Live" connection indicator

6. Test Chat (MOBL-05):
   - Navigate to Messages (from dashboard quick action or direct)
   - Should see conversation list
   - Open a conversation
   - Send a message
   - Should appear with "sent" indicator

7. Test Offline (MOBL-07):
   - Enable airplane mode
   - Should see "No internet connection" banner
   - Navigate through tabs - cached data should still display
   - Disable airplane mode - banner should disappear

8. Test Profile/Logout:
   - Navigate to Profile tab
   - Verify user info displayed
   - Tap Logout
   - Confirm logout
   - Should return to login screen
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
All MOBL requirements verified:
- MOBL-01: Login with session persistence
- MOBL-02: Check in/out with location
- MOBL-03: Timesheet entry
- MOBL-04: Team presence/availability
- MOBL-05: Chat (1:1 and groups)
- MOBL-06: Location permission with explanation
- MOBL-07: Offline viewing
</verification>

<success_criteria>
- All 7 MOBL requirements functional
- App works on iOS simulator / Expo Go
- TypeScript compiles without errors
- Real-time features (presence, chat) working
- Offline mode shows cached data
</success_criteria>

<output>
After completion, create `.planning/phases/08-mobile-app/08-06-SUMMARY.md`
</output>
