---
phase: 08-mobile-app
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/mobile/src/store/presence.ts
  - apps/mobile/src/hooks/usePresence.ts
  - apps/mobile/src/components/team/TeamMemberCard.tsx
  - apps/mobile/src/components/team/TeamStatusFilter.tsx
  - apps/mobile/app/(tabs)/team.tsx
autonomous: true

must_haves:
  truths:
    - "User can view team presence list"
    - "Team members show Online/Away/Offline status"
    - "Status updates in real-time via WebSocket"
    - "User can filter by status"
  artifacts:
    - path: "apps/mobile/src/store/presence.ts"
      provides: "Presence state with Socket.IO and mobile reconnection"
      exports: ["usePresenceStore", "useFilteredTeamMembers"]
    - path: "apps/mobile/src/hooks/usePresence.ts"
      provides: "Presence hook with auto-connect"
      exports: ["usePresence"]
    - path: "apps/mobile/src/components/team/TeamMemberCard.tsx"
      provides: "Team member display card"
    - path: "apps/mobile/src/components/team/TeamStatusFilter.tsx"
      provides: "Status filter pills"
  key_links:
    - from: "apps/mobile/src/store/presence.ts"
      to: "socket.io-client"
      via: "WebSocket connection"
      pattern: "io\\("
    - from: "apps/mobile/src/store/presence.ts"
      to: "AppState"
      via: "reconnect on foreground"
      pattern: "AppState.addEventListener"
---

<objective>
Implement mobile team presence with real-time status updates.

Purpose: Allow employees to see which team members are online, away, or offline in real-time.
Output: Working team presence page with real-time WebSocket updates and status filtering.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-mobile-app/08-RESEARCH.md

# Web patterns to mirror
@apps/web/src/store/presence.ts

# Mobile foundation
@apps/mobile/src/lib/api.ts
@apps/mobile/src/store/auth.ts
@apps/mobile/src/theme/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mobile presence store with reconnection</name>
  <files>apps/mobile/src/store/presence.ts</files>
  <action>
Create `apps/mobile/src/store/presence.ts` - Zustand store mirroring web but with mobile-specific reconnection:

1. Import:
   - `create` from zustand
   - `io, Socket` from socket.io-client
   - `AppState, AppStateStatus` from react-native
   - `NetInfo` from @react-native-community/netinfo

2. Define same types as web:
   - `PresenceStatus`: 'Online' | 'Away' | 'Offline' | 'Busy'
   - `TeamMember` interface (userId, status, lastSeenAt, profile, etc.)

3. Define `PresenceState` interface matching web:
   - socket, isConnected, connectionError
   - teamMembers, isLoading
   - statusFilter, departmentFilter
   - Actions: connect, disconnect, setTeamMembers, setStatusFilter, setDepartmentFilter
   - Socket actions: sendHeartbeat, setActivity, postStatus, clearStatus

4. `SOCKET_URL` derived from `EXPO_PUBLIC_API_URL` (strip /api/v1 path)

5. `connect(token: string)` implementation - MIRROR WEB but add mobile-specific:
   ```typescript
   const socket = io(`${SOCKET_URL}/presence`, {
     auth: { token },
     autoConnect: true,
     reconnection: true,
     reconnectionAttempts: 10,       // More for mobile
     reconnectionDelay: 1000,
     reconnectionDelayMax: 10000,    // Longer for cellular
     timeout: 20000,                 // Longer for slow networks
   });
   ```

   Same event handlers as web:
   - connect, disconnect, connect_error
   - user:online, user:offline
   - presence:update, activity:changed, status:updated

   **Mobile-specific additions:**
   ```typescript
   // Reconnect when app comes to foreground
   const appStateSubscription = AppState.addEventListener('change', (nextState: AppStateStatus) => {
     if (nextState === 'active' && !socket.connected) {
       console.log('[Presence] App foregrounded, reconnecting...');
       socket.connect();
     }
   });

   // Reconnect when network restored
   const netInfoUnsubscribe = NetInfo.addEventListener((state) => {
     if (state.isConnected && !socket.connected) {
       console.log('[Presence] Network restored, reconnecting...');
       socket.connect();
     }
   });

   // Store cleanup functions for disconnect
   ```

6. `disconnect()` - clean up subscriptions AND socket

7. Export selectors same as web:
   - `useFilteredTeamMembers()` - filters by status and department
   - `useUniqueDepartments()` - unique departments list
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Store includes AppState and NetInfo reconnection logic.
  </verify>
  <done>
Presence store created with mobile reconnection on foreground/network restore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePresence hook and team components</name>
  <files>
    apps/mobile/src/hooks/usePresence.ts
    apps/mobile/src/components/team/TeamMemberCard.tsx
    apps/mobile/src/components/team/TeamStatusFilter.tsx
  </files>
  <action>
**1. Create `apps/mobile/src/hooks/usePresence.ts`:**

Hook that auto-connects to presence socket and fetches initial team data:

```typescript
interface UsePresenceReturn {
  teamMembers: TeamMember[];
  isLoading: boolean;
  isConnected: boolean;
  error: string | null;
  statusFilter: PresenceStatus | null;
  setStatusFilter: (status: PresenceStatus | null) => void;
  refresh: () => Promise<void>;
}
```

Implementation:
- Use `usePresenceStore` for store access
- Use `useAuthStore` to get token
- On mount with token:
  1. Connect to WebSocket via store.connect(token)
  2. Fetch initial team via GET `/presence/team`
  3. Set team members in store
- On unmount: don't disconnect (keep socket alive for app)
- `refresh()` refetches team from API
- Return filtered members via `useFilteredTeamMembers()`

**2. Create `apps/mobile/src/components/team/TeamMemberCard.tsx`:**

Card displaying a team member:

Props: `member: TeamMember`

UI:
- Avatar placeholder (colored circle with initials, or avatarUrl if exists)
- Name: firstName lastName
- Designation
- Status indicator dot (green=Online, yellow=Away, gray=Offline)
- Status text ("Online", "Away - 5m ago", "Offline")
- Current activity if exists: "Working on [Project] - [Task]"
- Status message if exists (italic, truncated)

Use `formatDistanceToNow` from date-fns for "5m ago" formatting.
Card should have subtle shadow and rounded corners.

**3. Create `apps/mobile/src/components/team/TeamStatusFilter.tsx`:**

Horizontal pill/chip filter:

Props:
```typescript
{
  selected: PresenceStatus | null;
  onSelect: (status: PresenceStatus | null) => void;
  counts: { online: number; away: number; offline: number };
}
```

UI:
- Horizontal ScrollView with pills
- Pills: "All (X)", "Online (X)", "Away (X)", "Offline (X)"
- Selected pill has filled background
- Unselected has outline
- Tap to select/deselect (deselecting returns to "All")

Style with theme colors - green for Online, yellow for Away, gray for Offline.
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Components render with proper prop types.
  </verify>
  <done>
usePresence hook auto-connects and provides team data.
TeamMemberCard shows member with status.
TeamStatusFilter provides status filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire team tab page</name>
  <files>apps/mobile/app/(tabs)/team.tsx</files>
  <action>
Update `apps/mobile/app/(tabs)/team.tsx` to implement team presence:

1. Import:
   - `usePresence` hook
   - `TeamMemberCard`, `TeamStatusFilter` components
   - `FlatList, RefreshControl` from react-native

2. Use hook:
   ```typescript
   const {
     teamMembers,
     isLoading,
     isConnected,
     statusFilter,
     setStatusFilter,
     refresh
   } = usePresence();
   ```

3. Calculate counts for filter:
   ```typescript
   const counts = useMemo(() => ({
     online: teamMembers.filter(m => m.status === 'Online').length,
     away: teamMembers.filter(m => m.status === 'Away').length,
     offline: teamMembers.filter(m => m.status === 'Offline').length,
   }), [teamMembers]);
   ```

4. Layout:
   ```
   Header: "Team" (already set by tab)

   Connection indicator (small, top-right):
     - Green dot + "Live" if connected
     - Red dot + "Reconnecting..." if not connected

   TeamStatusFilter (horizontal, sticky)

   FlatList of TeamMemberCards:
     - RefreshControl for pull-to-refresh
     - Empty state if no members
     - Loading skeleton if isLoading and no data
   ```

5. FlatList config:
   - `data={teamMembers}`
   - `keyExtractor={(item) => item.userId}`
   - `renderItem={({ item }) => <TeamMemberCard member={item} />}`
   - `refreshControl={<RefreshControl refreshing={isLoading} onRefresh={refresh} />}`
   - `ListEmptyComponent` for empty state
   - `contentContainerStyle` with padding

6. Apply filter to displayed list (from useFilteredTeamMembers)

7. Animated entrance for cards using FadeInDown stagger.

Style consistently with other tabs using theme.
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Team tab shows members with real-time updates.
  </verify>
  <done>
Team page shows presence list with:
- Real-time WebSocket updates
- Status filtering
- Pull to refresh
- Connection indicator
  </done>
</task>

</tasks>

<verification>
1. `cd apps/mobile && npm run typecheck` passes
2. Team list shows members from API
3. Status updates reflect in real-time (test by changing status elsewhere)
4. Filtering by Online/Away/Offline works
5. Connection indicator shows correct state
</verification>

<success_criteria>
- User can view team presence/availability (MOBL-04)
- Team members show Online/Away/Offline status
- Status updates in real-time via WebSocket
- Reconnects when app comes to foreground
- Reconnects when network restores
- Filter by status works
</success_criteria>

<output>
After completion, create `.planning/phases/08-mobile-app/08-04-SUMMARY.md`
</output>
