---
phase: 08-mobile-app
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/package.json
  - apps/mobile/src/lib/api.ts
  - apps/mobile/src/lib/location.ts
  - apps/mobile/src/lib/offline.ts
  - apps/mobile/app/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "React Query persists cache to AsyncStorage"
    - "Network status is detectable"
    - "Location can be requested with permission"
    - "API client handles offline gracefully"
  artifacts:
    - path: "apps/mobile/src/lib/api.ts"
      provides: "Mobile API client with auth and offline awareness"
      exports: ["api", "apiClient"]
    - path: "apps/mobile/src/lib/location.ts"
      provides: "Location permission and GPS utilities"
      exports: ["requestLocationPermission", "getCurrentLocation"]
    - path: "apps/mobile/src/lib/offline.ts"
      provides: "Offline queue and network detection"
      exports: ["useNetworkStatus", "offlineQueue"]
  key_links:
    - from: "apps/mobile/app/_layout.tsx"
      to: "PersistQueryClientProvider"
      via: "wrapping children"
      pattern: "PersistQueryClientProvider"
    - from: "apps/mobile/src/lib/api.ts"
      to: "SecureStore"
      via: "token retrieval"
      pattern: "SecureStore.getItemAsync"
---

<objective>
Set up mobile app foundation with offline support, location utilities, and API client.

Purpose: All mobile features depend on these shared utilities - offline detection, location services, and authenticated API calls.
Output: Working mobile foundation with React Query persistence, location helpers, and network-aware API client.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-mobile-app/08-RESEARCH.md

# Existing mobile app structure
@apps/mobile/package.json
@apps/mobile/app/_layout.tsx
@apps/mobile/src/store/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure React Query persistence</name>
  <files>
    apps/mobile/package.json
    apps/mobile/app/_layout.tsx
  </files>
  <action>
Install required packages for offline support:
```bash
cd apps/mobile
npx expo install expo-task-manager @react-native-community/netinfo @react-native-async-storage/async-storage
npm install @tanstack/query-async-storage-persister @tanstack/react-query-persist-client date-fns
```

Update `app/_layout.tsx` to wrap the app with `PersistQueryClientProvider`:

1. Import dependencies:
   - `createAsyncStoragePersister` from `@tanstack/query-async-storage-persister`
   - `PersistQueryClientProvider` from `@tanstack/react-query-persist-client`
   - `AsyncStorage` from `@react-native-async-storage/async-storage`

2. Configure QueryClient with offline-first defaults:
   - `gcTime: 1000 * 60 * 60 * 24` (24 hours)
   - `staleTime: 1000 * 60 * 5` (5 minutes)
   - `networkMode: 'offlineFirst'`
   - `refetchOnWindowFocus: false` (prevent duplicate calls on tab focus)
   - `retry: 2`

3. Create asyncStoragePersister with key `'satcom-mobile-cache'`

4. Replace `QueryClientProvider` with `PersistQueryClientProvider`:
   ```tsx
   <PersistQueryClientProvider
     client={queryClient}
     persistOptions={{ persister: asyncStoragePersister }}
   >
   ```

Keep existing providers (GestureHandlerRootView, StatusBar) and auth initialization logic intact.
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes without errors.
Verify package.json includes new dependencies.
  </verify>
  <done>
React Query configured with AsyncStorage persistence.
App wraps children in PersistQueryClientProvider.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mobile API client with auth and offline handling</name>
  <files>apps/mobile/src/lib/api.ts</files>
  <action>
Create `apps/mobile/src/lib/api.ts` - authenticated API client for mobile:

1. Import SecureStore for token retrieval
2. Define `API_URL` from `process.env.EXPO_PUBLIC_API_URL` with fallback to `http://localhost:3001/api/v1`

3. Create `ApiClient` class with methods:
   - `async getToken(): Promise<string | null>` - retrieves access token from SecureStore
   - `async request<T>(endpoint: string, options?: RequestInit): Promise<ApiResponse<T>>`
     - Attaches Authorization header if token exists
     - Sets Content-Type to application/json
     - Handles network errors gracefully (return `{ success: false, error: { message: 'Network error' } }`)
     - Parses JSON response
   - `async get<T>(endpoint: string): Promise<ApiResponse<T>>`
   - `async post<T>(endpoint: string, body: unknown): Promise<ApiResponse<T>>`
   - `async patch<T>(endpoint: string, body: unknown): Promise<ApiResponse<T>>`
   - `async delete<T>(endpoint: string): Promise<ApiResponse<T>>`

4. Export singleton `api` instance and `apiClient` for direct access

5. Define `ApiResponse<T>` type matching web API response format:
   ```typescript
   interface ApiResponse<T> {
     success: boolean;
     data?: T;
     error?: { message: string; code?: string };
   }
   ```

Pattern should mirror `apps/web/src/lib/api.ts` but use SecureStore instead of cookies and handle offline gracefully.
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
File exports api, apiClient, and ApiResponse type.
  </verify>
  <done>
Mobile API client exists with auth token handling and offline-aware error handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create location utilities with permission flow</name>
  <files>apps/mobile/src/lib/location.ts</files>
  <action>
Create `apps/mobile/src/lib/location.ts` with location permission and GPS utilities:

1. Import `* as Location` from `expo-location`

2. `requestLocationPermission()`: Returns `Promise<{ granted: boolean; background: boolean }>`
   - First request foreground permission via `Location.requestForegroundPermissionsAsync()`
   - If foreground granted, optionally request background via `Location.requestBackgroundPermissionsAsync()`
   - Return both statuses

3. `checkLocationPermission()`: Returns `Promise<{ foreground: boolean; background: boolean }>`
   - Uses `Location.getForegroundPermissionsAsync()` and `Location.getBackgroundPermissionsAsync()`
   - Does NOT prompt user, just checks current status

4. `getCurrentLocation(accuracy?: Location.Accuracy)`: Returns `Promise<{ latitude: number; longitude: number } | null>`
   - Default accuracy: `Location.Accuracy.High` (for check-in)
   - Uses `Location.getCurrentPositionAsync({ accuracy })`
   - Returns null on error (log error but don't throw)

5. `LocationAccuracy` export - re-export `Location.Accuracy` for convenience

6. Add JSDoc comments explaining:
   - Use `Accuracy.High` for check-in (one-time, precise)
   - Use `Accuracy.Balanced` for heartbeats (battery-efficient)

Follow patterns from research: https://docs.expo.dev/versions/latest/sdk/location/
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
File exports requestLocationPermission, checkLocationPermission, getCurrentLocation, LocationAccuracy.
  </verify>
  <done>
Location utilities exist with permission request flow and GPS retrieval.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/mobile && npm run typecheck` passes
2. All new files exist with correct exports
3. `_layout.tsx` uses PersistQueryClientProvider
4. No circular import issues
</verification>

<success_criteria>
- Dependencies installed (expo-task-manager, netinfo, async-storage, query-persist)
- React Query persistence configured in root layout
- API client handles auth tokens from SecureStore
- Location utilities provide permission flow and GPS access
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-mobile-app/08-01-SUMMARY.md`
</output>
