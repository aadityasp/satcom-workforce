---
phase: 08-mobile-app
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/mobile/src/hooks/useAttendance.ts
  - apps/mobile/src/hooks/useLocation.ts
  - apps/mobile/src/components/attendance/CheckInModal.tsx
  - apps/mobile/src/components/attendance/AttendanceCard.tsx
  - apps/mobile/app/(tabs)/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can check in with location capture"
    - "User can check out and see summary"
    - "User can start/end breaks"
    - "Location permission is requested with explanation"
    - "Dashboard shows real attendance data"
  artifacts:
    - path: "apps/mobile/src/hooks/useAttendance.ts"
      provides: "Attendance state and API operations"
      exports: ["useAttendance"]
    - path: "apps/mobile/src/hooks/useLocation.ts"
      provides: "Location permission hook with explanation UI"
      exports: ["useLocation"]
    - path: "apps/mobile/src/components/attendance/CheckInModal.tsx"
      provides: "Work mode selection and check-in UI"
    - path: "apps/mobile/src/components/attendance/AttendanceCard.tsx"
      provides: "Status display with check-in/out buttons"
  key_links:
    - from: "apps/mobile/src/hooks/useAttendance.ts"
      to: "apps/mobile/src/lib/api.ts"
      via: "API calls"
      pattern: "api\\.(get|post)"
    - from: "apps/mobile/src/components/attendance/CheckInModal.tsx"
      to: "apps/mobile/src/lib/location.ts"
      via: "GPS capture"
      pattern: "getCurrentLocation"
---

<objective>
Implement mobile attendance with location capture for check-in/out and breaks.

Purpose: Core functionality allowing employees to track their work hours with GPS verification from mobile devices.
Output: Working attendance flow with check-in modal, real-time status card, and location permission handling.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-mobile-app/08-RESEARCH.md

# Web patterns to mirror
@apps/web/src/hooks/useAttendance.ts

# Mobile foundation (from 08-01)
@apps/mobile/src/lib/api.ts
@apps/mobile/src/lib/location.ts
@apps/mobile/src/theme/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLocation hook with permission explanation</name>
  <files>apps/mobile/src/hooks/useLocation.ts</files>
  <action>
Create `apps/mobile/src/hooks/useLocation.ts` - hook for location permission with user-friendly explanation:

1. Import:
   - `useState, useCallback` from react
   - `Alert` from react-native
   - Location utilities from `../lib/location`

2. Create `useLocation()` hook returning:
   ```typescript
   {
     hasPermission: boolean | null;  // null = not yet checked
     isRequesting: boolean;
     requestPermission: () => Promise<boolean>;
     getCurrentPosition: () => Promise<{ latitude: number; longitude: number } | null>;
   }
   ```

3. `requestPermission()` implementation:
   - First check current status via `checkLocationPermission()`
   - If already granted, return true immediately
   - If not granted, show Alert.alert with:
     - Title: "Location Required"
     - Message: "Satcom Workforce needs your location to verify your check-in at office locations. Your location is only captured during check-in/out and is not tracked continuously."
     - Button: "Allow" -> calls `requestLocationPermission()`
   - Update `hasPermission` state based on result
   - Return whether permission was granted

4. `getCurrentPosition()` implementation:
   - If no permission, call `requestPermission()` first
   - If still no permission after request, return null
   - Otherwise call `getCurrentLocation()` from lib/location

5. On mount, check permission status (but don't prompt)

This addresses MOBL-06: "App explains why location needed before requesting"
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Hook exports useLocation with permission flow.
  </verify>
  <done>
useLocation hook exists with permission explanation Alert before requesting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAttendance hook mirroring web</name>
  <files>apps/mobile/src/hooks/useAttendance.ts</files>
  <action>
Create `apps/mobile/src/hooks/useAttendance.ts` - mirror web hook for React Native:

1. Import `api` from `../lib/api` and types

2. Define same types as web (can copy from `apps/web/src/hooks/useAttendance.ts`):
   - `AttendanceStatus`, `WorkMode`, `BreakType`
   - `AttendanceEvent`, `BreakSegment`, `CurrentBreak`, `WorkPolicy`
   - `AttendanceDay`, `CheckOutSummary`

3. Create `useAttendance()` hook with same interface as web:
   ```typescript
   {
     attendance: AttendanceDay | null;
     isLoading: boolean;
     isActionLoading: boolean;
     error: string | null;
     refresh: () => Promise<void>;
     checkIn: (workMode: WorkMode, latitude?: number, longitude?: number) => Promise<boolean>;
     checkOut: (latitude?: number, longitude?: number) => Promise<CheckOutSummary | null>;
     startBreak: (type: BreakType) => Promise<boolean>;
     endBreak: () => Promise<boolean>;
     clearError: () => void;
   }
   ```

4. Implementation follows web hook exactly:
   - `refresh()` calls GET `/attendance/today`
   - `checkIn()` calls POST `/attendance/check-in` with workMode and coordinates
   - `checkOut()` calls POST `/attendance/check-out` with coordinates
   - `startBreak()` calls POST `/attendance/break/start`
   - `endBreak()` calls POST `/attendance/break/{id}/end`

5. Use `useState` for state management (same as web pattern)
6. Fetch on mount via `useEffect`
7. Export types as well as hook

Key difference from web: Uses mobile `api` client (SecureStore auth).
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Hook interface matches web version.
  </verify>
  <done>
useAttendance hook exists with all attendance operations mirroring web.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create attendance UI components and wire dashboard</name>
  <files>
    apps/mobile/src/components/attendance/CheckInModal.tsx
    apps/mobile/src/components/attendance/AttendanceCard.tsx
    apps/mobile/app/(tabs)/index.tsx
  </files>
  <action>
Create attendance components and update dashboard:

**1. Create `apps/mobile/src/components/attendance/CheckInModal.tsx`:**

Modal for work mode selection and check-in:
- Props: `visible: boolean`, `onClose: () => void`, `onCheckIn: (workMode: WorkMode) => Promise<void>`, `isLoading: boolean`
- Use `Modal` from react-native with transparent background
- Display work mode options as radio/selection list:
  - Office, Remote, CustomerSite, FieldVisit, Travel
- Each option shows icon and label
- "Check In" button at bottom
- When pressed, calls `onCheckIn(selectedWorkMode)`
- Use theme colors and borderRadius from `../../theme`
- Animated entrance using react-native-reanimated FadeIn

**2. Create `apps/mobile/src/components/attendance/AttendanceCard.tsx`:**

Card displaying current attendance status:
- Props: Pass `attendance: AttendanceDay`, `onCheckIn`, `onCheckOut`, `onBreak`, `onEndBreak`, `isActionLoading`
- Display:
  - Status icon (green if working, gray if not checked in)
  - "Today's Status" label
  - Status text ("Checked in at 9:15 AM" or "Not checked in")
  - Work mode if checked in
- Action buttons based on status:
  - `not_checked_in`: "Check In" button
  - `working`: "Break" and "Check Out" buttons
  - `on_break`: "End Break" button
- Time summary section (if checked in):
  - Work time, Break time, Remaining (8h target)
- Use existing styles from current index.tsx as reference
- Use theme from `../../theme`

**3. Update `apps/mobile/app/(tabs)/index.tsx`:**

Replace mock data with real attendance:
1. Import `useAttendance` and `useLocation` hooks
2. Import `CheckInModal` and `AttendanceCard` components
3. Add state for `showCheckInModal: boolean`
4. Use `useAttendance()` for real data
5. Use `useLocation()` for GPS capture

Wire up the flow:
- "Check In" button opens CheckInModal
- Modal check-in triggers:
  1. `getCurrentPosition()` from useLocation
  2. `checkIn(workMode, lat, lng)` from useAttendance
  3. Close modal on success
- "Check Out" button:
  1. Gets current position
  2. Calls `checkOut(lat, lng)`
  3. Shows Alert with summary on success
- "Break" / "End Break" buttons call respective functions

Replace the mock `AttendanceStatus` interface with real data from hook.
Keep existing quick actions grid and recent activity sections.
Update RefreshControl to call `refresh()` from useAttendance.
  </action>
  <verify>
`cd apps/mobile && npm run typecheck` passes.
Components exist in correct paths.
Dashboard imports and uses attendance hooks.
  </verify>
  <done>
Attendance components created.
Dashboard wired to real attendance data with location capture.
Check-in flow captures GPS and sends to API.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/mobile && npm run typecheck` passes
2. Check-in flow requests location permission with explanation
3. Attendance card shows real data (or loading state)
4. Work mode selection modal appears on check-in
5. Check-out shows summary alert
</verification>

<success_criteria>
- useLocation hook shows explanation before requesting permission (MOBL-06)
- useAttendance hook provides all attendance operations
- Dashboard shows real attendance status
- Check-in captures GPS coordinates
- Check-out displays work summary
- Breaks can be started/ended
</success_criteria>

<output>
After completion, create `.planning/phases/08-mobile-app/08-02-SUMMARY.md`
</output>
