---
phase: 04-location-geofence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/locations/locations.module.ts
  - apps/api/src/locations/locations.service.ts
  - apps/api/src/locations/locations.controller.ts
  - apps/api/src/locations/dto/create-location.dto.ts
  - apps/api/src/locations/dto/update-location.dto.ts
  - apps/api/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Super Admin can create new office locations with name, address, coordinates, radius"
    - "Super Admin can update existing office locations"
    - "Super Admin can delete (deactivate) office locations"
    - "Super Admin can view all office locations for the company"
    - "Non-admin users cannot access location management endpoints"
  artifacts:
    - path: "apps/api/src/locations/locations.module.ts"
      provides: "NestJS module for locations"
      exports: ["LocationsModule"]
    - path: "apps/api/src/locations/locations.service.ts"
      provides: "CRUD operations for OfficeLocation"
      min_lines: 80
    - path: "apps/api/src/locations/locations.controller.ts"
      provides: "REST endpoints for location management"
      exports: ["LocationsController"]
  key_links:
    - from: "apps/api/src/locations/locations.controller.ts"
      to: "apps/api/src/locations/locations.service.ts"
      via: "dependency injection"
      pattern: "LocationsService"
    - from: "apps/api/src/locations/locations.service.ts"
      to: "prisma.officeLocation"
      via: "database query"
      pattern: "prisma\\.officeLocation\\.(findMany|create|update)"
---

<objective>
Create Office Location CRUD API for Super Admin to manage geofence office locations.

Purpose: Enable configuration of office locations with coordinates and radius for geofence verification (LOCN-01, LOCN-02).
Output: REST API endpoints for creating, reading, updating, and deleting office locations.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-location-geofence/04-RESEARCH.md
@apps/api/prisma/schema.prisma
@apps/api/src/attendance/geofence.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DTOs for office location management</name>
  <files>
    apps/api/src/locations/dto/create-location.dto.ts
    apps/api/src/locations/dto/update-location.dto.ts
  </files>
  <action>
Create DTOs for office location CRUD operations:

**create-location.dto.ts:**
- name: string (required, min 2, max 100)
- address: string (required, min 5, max 500)
- latitude: number (required, use @IsLatitude)
- longitude: number (required, use @IsLongitude)
- radiusMeters: number (required, @Min(50), @Max(5000))

**update-location.dto.ts:**
- Extend PartialType of CreateOfficeLocationDto
- Add isActive: boolean (optional)

Use class-validator decorators for validation. Import from @nestjs/mapped-types for PartialType.
  </action>
  <verify>TypeScript compiles without errors: `npm run build --workspace=apps/api`</verify>
  <done>DTOs exist with proper validation decorators</done>
</task>

<task type="auto">
  <name>Task 2: Create LocationsService with CRUD operations</name>
  <files>apps/api/src/locations/locations.service.ts</files>
  <action>
Create LocationsService with methods:

1. **findAll(companyId: string)**: Return all office locations for company
2. **findOne(id: string, companyId: string)**: Return single location, throw NotFoundException if not found or wrong company
3. **create(companyId: string, dto: CreateOfficeLocationDto)**: Create new office location
4. **update(id: string, companyId: string, dto: UpdateOfficeLocationDto)**: Update existing location
5. **remove(id: string, companyId: string)**: Soft delete by setting isActive = false

Inject PrismaService. Use companyId for all queries to enforce tenant isolation.
Create AuditLog entries for create, update, remove operations.
  </action>
  <verify>`npm run build --workspace=apps/api` succeeds</verify>
  <done>LocationsService has all CRUD methods with proper tenant isolation</done>
</task>

<task type="auto">
  <name>Task 3: Create LocationsController and Module</name>
  <files>
    apps/api/src/locations/locations.controller.ts
    apps/api/src/locations/locations.module.ts
    apps/api/src/app.module.ts
  </files>
  <action>
**LocationsController:**
- Use @Controller('locations') prefix
- All endpoints require @Roles(UserRole.SuperAdmin) decorator
- GET / - List all locations (return service.findAll)
- GET /:id - Get single location (return service.findOne)
- POST / - Create location (use CreateOfficeLocationDto, @Body)
- PATCH /:id - Update location (use UpdateOfficeLocationDto)
- DELETE /:id - Remove location (soft delete)

Extract companyId from @CurrentUser() decorator (user.companyId).
Use @CurrentUser() from existing auth decorators.

**LocationsModule:**
- Import PrismaModule
- Provide and export LocationsService
- Declare LocationsController

**app.module.ts:**
- Add LocationsModule to imports array
  </action>
  <verify>
Start dev server: `npm run dev --workspace=apps/api`
Test with curl:
```
curl -X GET http://localhost:3001/locations -H "Authorization: Bearer $TOKEN"
```
Should return empty array or 401 if not authenticated.
  </verify>
  <done>Locations endpoints accessible, properly protected by SuperAdmin role</done>
</task>

</tasks>

<verification>
1. API builds: `npm run build --workspace=apps/api`
2. Endpoints respond:
   - GET /locations returns array
   - POST /locations creates new location
   - GET /locations/:id returns single location
   - PATCH /locations/:id updates location
   - DELETE /locations/:id soft-deletes location
3. Non-SuperAdmin users get 403 Forbidden
4. Audit logs created for mutations
</verification>

<success_criteria>
- Office location CRUD API fully functional
- All endpoints protected by SuperAdmin role
- Tenant isolation enforced (companyId filtering)
- Audit logging for create/update/delete
- TypeScript builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-location-geofence/04-01-SUMMARY.md`
</output>
