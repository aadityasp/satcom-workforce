---
phase: 04-location-geofence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/attendance/geofence.service.ts
  - apps/api/src/attendance/attendance.service.ts
  - apps/api/src/attendance/attendance.module.ts
autonomous: true

must_haves:
  truths:
    - "When Office check-in fails geofence, an anomaly is created"
    - "Anomaly contains location data (lat, lng, timestamp)"
    - "Remote/Field/Travel work modes skip geofence verification"
    - "Check-in response includes verification status"
  artifacts:
    - path: "apps/api/src/attendance/geofence.service.ts"
      provides: "Geofence validation with anomaly creation"
      min_lines: 120
  key_links:
    - from: "apps/api/src/attendance/attendance.service.ts"
      to: "apps/api/src/attendance/geofence.service.ts"
      via: "dependency injection"
      pattern: "geofenceService\\.validateAndCreateAnomaly"
    - from: "apps/api/src/attendance/geofence.service.ts"
      to: "prisma.anomalyEvent"
      via: "database create"
      pattern: "prisma\\.anomalyEvent\\.create"
---

<objective>
Enhance GeofenceService to create anomaly events when geofence verification fails.

Purpose: Automatically flag check-ins outside office radius for HR review (LOCN-03, LOCN-04, LOCN-05).
Output: Enhanced geofence service that creates anomalies on failure, attendance service integration.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-location-geofence/04-RESEARCH.md
@apps/api/src/attendance/geofence.service.ts
@apps/api/src/attendance/attendance.service.ts
@apps/api/src/anomalies/anomalies.service.ts
@apps/api/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anomaly creation to GeofenceService</name>
  <files>apps/api/src/attendance/geofence.service.ts</files>
  <action>
Add new method `validateAndCreateAnomaly` that:

1. Calls existing `validateLocation()` method
2. If result is `VerificationStatus.GeofenceFailed`:
   - Query `AnomalyRule` for type `AnomalyType.GeofenceFailure` where `isEnabled: true` and `companyId` matches
   - If rule exists, create `AnomalyEvent`:
     - userId: from parameter
     - ruleId: from found rule
     - type: AnomalyType.GeofenceFailure
     - severity: from rule.severity
     - status: AnomalyStatus.Open
     - title: "Check-in Outside Geofence"
     - description: "User attempted Office check-in from location outside configured office radius"
     - data: JSON with { latitude, longitude, timestamp, verificationStatus }
3. Return the VerificationStatus

Method signature:
```typescript
async validateAndCreateAnomaly(
  userId: string,
  companyId: string,
  latitude?: number,
  longitude?: number,
): Promise<VerificationStatus>
```

Keep existing `validateLocation()` method unchanged for backwards compatibility.
  </action>
  <verify>`npm run build --workspace=apps/api` succeeds</verify>
  <done>GeofenceService has validateAndCreateAnomaly method that creates anomaly on failure</done>
</task>

<task type="auto">
  <name>Task 2: Update AttendanceService to use enhanced geofence validation</name>
  <files>apps/api/src/attendance/attendance.service.ts</files>
  <action>
In the `checkIn()` method, replace the call to `geofenceService.validateLocation()` with `geofenceService.validateAndCreateAnomaly()`.

Current code (around line 67):
```typescript
verificationStatus = await this.geofenceService.validateLocation(
  companyId,
  checkInDto.latitude,
  checkInDto.longitude,
);
```

Update to:
```typescript
verificationStatus = await this.geofenceService.validateAndCreateAnomaly(
  userId,
  companyId,
  checkInDto.latitude,
  checkInDto.longitude,
);
```

The existing logic for only checking Office work mode should remain:
```typescript
if (checkInDto.workMode === WorkMode.Office) {
  verificationStatus = await this.geofenceService.validateAndCreateAnomaly(...)
}
```

This ensures Remote, CustomerSite, FieldVisit, Travel modes skip geofence verification entirely.
  </action>
  <verify>
1. `npm run build --workspace=apps/api` succeeds
2. Test check-in flow still works
  </verify>
  <done>AttendanceService uses enhanced geofence validation with anomaly creation</done>
</task>

<task type="auto">
  <name>Task 3: Ensure anomaly rule seeding for GeofenceFailure</name>
  <files>apps/api/prisma/seed.ts</files>
  <action>
Check if seed.ts exists. If it does, verify there's a seed for AnomalyRule with type GeofenceFailure.

If no seed exists, add one in the seeding logic:

```typescript
// Seed GeofenceFailure anomaly rule
await prisma.anomalyRule.upsert({
  where: {
    companyId_type: {
      companyId: company.id,
      type: 'GeofenceFailure',
    },
  },
  update: {},
  create: {
    companyId: company.id,
    type: 'GeofenceFailure',
    name: 'Geofence Verification Failed',
    description: 'Check-in from outside configured office geofence radius',
    isEnabled: true,
    severity: 'Medium',
    threshold: 1,
    windowDays: 1,
    config: {},
  },
});
```

If no seed.ts exists, create a note in the code comment that this rule should be created via admin UI or migration.
  </action>
  <verify>Run `npx prisma db seed` or verify build succeeds if no seeding changes needed</verify>
  <done>GeofenceFailure anomaly rule will exist when geofence verification runs</done>
</task>

</tasks>

<verification>
1. API builds: `npm run build --workspace=apps/api`
2. Office check-in with invalid coordinates creates anomaly
3. Office check-in with valid coordinates (within radius) creates no anomaly
4. Remote/Field/Travel check-ins create no anomaly regardless of location
5. Anomaly data includes latitude, longitude, timestamp
</verification>

<success_criteria>
- GeofenceService.validateAndCreateAnomaly creates anomaly on failure
- AttendanceService uses enhanced validation method
- Anomaly rule exists for GeofenceFailure type
- Non-office work modes bypass geofence entirely
- Check-in response includes verification status
</success_criteria>

<output>
After completion, create `.planning/phases/04-location-geofence/04-02-SUMMARY.md`
</output>
