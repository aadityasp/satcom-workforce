---
phase: 04-location-geofence
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - apps/web/src/app/admin/map/page.tsx
  - apps/web/src/components/map/LocationMap.tsx
  - apps/web/src/components/map/UserMarker.tsx
  - apps/web/src/hooks/useCheckInLocations.ts
  - apps/api/src/attendance/attendance.controller.ts
  - apps/api/src/attendance/attendance.service.ts
autonomous: true

must_haves:
  truths:
    - "Super Admin can view a map showing all users' check-in locations"
    - "Map displays office geofence circles with configured radius"
    - "Each marker shows user name and check-in time on click"
    - "Map filters by date (today, last 7 days)"
    - "Non-SuperAdmin users cannot access the map page"
  artifacts:
    - path: "apps/web/src/app/admin/map/page.tsx"
      provides: "Admin map view page"
      min_lines: 80
    - path: "apps/web/src/components/map/LocationMap.tsx"
      provides: "React-Leaflet map component"
      min_lines: 100
    - path: "apps/api/src/attendance/attendance.controller.ts"
      provides: "Endpoint for fetching check-in locations"
      contains: "getCheckInLocations"
  key_links:
    - from: "apps/web/src/components/map/LocationMap.tsx"
      to: "react-leaflet"
      via: "import"
      pattern: "from 'react-leaflet'"
    - from: "apps/web/src/hooks/useCheckInLocations.ts"
      to: "/api/attendance/locations"
      via: "fetch"
      pattern: "fetch.*attendance/locations"
---

<objective>
Create Super Admin map view showing all users' check-in locations with geofence circles.

Purpose: Enable Super Admin to visualize where employees are checking in and verify geofence coverage (LOCN-06, LOCN-07, LOCN-08).
Output: Interactive map page with user markers, geofence circles, and date filtering.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-location-geofence/04-RESEARCH.md
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React-Leaflet and add API endpoint for check-in locations</name>
  <files>
    apps/web/package.json
    apps/api/src/attendance/attendance.controller.ts
    apps/api/src/attendance/attendance.service.ts
  </files>
  <action>
**Install React-Leaflet (in apps/web):**
```bash
cd apps/web && npm install leaflet react-leaflet @types/leaflet
```

**Add API endpoint for check-in locations:**

In AttendanceService, add method:
```typescript
async getCheckInLocations(companyId: string, options: { startDate: Date; endDate: Date }) {
  const events = await this.prisma.attendanceEvent.findMany({
    where: {
      type: AttendanceEventType.CheckIn,
      timestamp: {
        gte: options.startDate,
        lte: options.endDate,
      },
      latitude: { not: null },
      longitude: { not: null },
      attendanceDay: {
        user: { companyId },
      },
    },
    include: {
      attendanceDay: {
        include: {
          user: {
            include: { profile: true },
          },
        },
      },
    },
    orderBy: { timestamp: 'desc' },
  });

  return events.map(event => ({
    id: event.id,
    userId: event.attendanceDay.userId,
    userName: event.attendanceDay.user.profile
      ? `${event.attendanceDay.user.profile.firstName} ${event.attendanceDay.user.profile.lastName}`
      : event.attendanceDay.user.email,
    latitude: Number(event.latitude),
    longitude: Number(event.longitude),
    timestamp: event.timestamp.toISOString(),
    workMode: event.workMode,
    verificationStatus: event.verificationStatus,
  }));
}
```

In AttendanceController, add endpoint:
```typescript
@Get('locations')
@Roles(UserRole.SuperAdmin)
async getCheckInLocations(
  @CurrentUser() user: { companyId: string },
  @Query('startDate') startDate: string,
  @Query('endDate') endDate: string,
) {
  return this.attendanceService.getCheckInLocations(user.companyId, {
    startDate: new Date(startDate),
    endDate: new Date(endDate),
  });
}
```
  </action>
  <verify>
1. `npm run build --workspace=apps/api` succeeds
2. GET /attendance/locations?startDate=...&endDate=... returns array
  </verify>
  <done>React-Leaflet installed, check-in locations API endpoint exists</done>
</task>

<task type="auto">
  <name>Task 2: Create useCheckInLocations hook</name>
  <files>apps/web/src/hooks/useCheckInLocations.ts</files>
  <action>
Create React Query hook for fetching check-in locations:

```typescript
import { useQuery } from '@tanstack/react-query';

interface CheckInLocation {
  id: string;
  userId: string;
  userName: string;
  latitude: number;
  longitude: number;
  timestamp: string;
  workMode: string;
  verificationStatus: string;
}

interface UseCheckInLocationsOptions {
  startDate: Date;
  endDate: Date;
}

export function useCheckInLocations(options: UseCheckInLocationsOptions) {
  return useQuery({
    queryKey: ['check-in-locations', options.startDate.toISOString(), options.endDate.toISOString()],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: options.startDate.toISOString(),
        endDate: options.endDate.toISOString(),
      });
      const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/attendance/locations?${params}`, {
        credentials: 'include',
      });
      if (!res.ok) throw new Error('Failed to fetch locations');
      return res.json() as Promise<CheckInLocation[]>;
    },
    staleTime: 30000, // 30 seconds
  });
}
```

Export the CheckInLocation type for use in map components.
  </action>
  <verify>TypeScript compiles: `npm run build --workspace=apps/web`</verify>
  <done>useCheckInLocations hook fetches location data with date filtering</done>
</task>

<task type="auto">
  <name>Task 3: Create LocationMap component with markers and geofence circles</name>
  <files>
    apps/web/src/components/map/LocationMap.tsx
    apps/web/src/components/map/UserMarker.tsx
  </files>
  <action>
**LocationMap.tsx:**
Create the main map component using React-Leaflet with dynamic import for Next.js SSR compatibility.

```tsx
'use client';

import { MapContainer, TileLayer, Marker, Popup, Circle } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// Fix Leaflet default icon issue
import markerIcon from 'leaflet/dist/images/marker-icon.png';
import markerIcon2x from 'leaflet/dist/images/marker-icon-2x.png';
import markerShadow from 'leaflet/dist/images/marker-shadow.png';

delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconUrl: markerIcon.src,
  iconRetinaUrl: markerIcon2x.src,
  shadowUrl: markerShadow.src,
});

interface CheckInLocation {
  id: string;
  userId: string;
  userName: string;
  latitude: number;
  longitude: number;
  timestamp: string;
  workMode: string;
  verificationStatus: string;
}

interface OfficeLocation {
  id: string;
  name: string;
  latitude: number;
  longitude: number;
  radiusMeters: number;
}

interface LocationMapProps {
  checkIns: CheckInLocation[];
  offices: OfficeLocation[];
  center?: [number, number];
  zoom?: number;
}

export function LocationMap({ checkIns, offices, center, zoom = 12 }: LocationMapProps) {
  // Calculate center from first office or first check-in, or default
  const mapCenter = center ||
    (offices[0] ? [offices[0].latitude, offices[0].longitude] :
    (checkIns[0] ? [checkIns[0].latitude, checkIns[0].longitude] :
    [12.9716, 77.5946])); // Default: Bangalore

  // Color markers based on verification status
  const getMarkerColor = (status: string) => {
    switch (status) {
      case 'GeofencePassed': return 'green';
      case 'GeofenceFailed': return 'red';
      default: return 'blue';
    }
  };

  return (
    <MapContainer
      center={mapCenter as [number, number]}
      zoom={zoom}
      className="h-full w-full rounded-lg"
      style={{ minHeight: '500px' }}
    >
      <TileLayer
        attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />

      {/* Office geofence circles */}
      {offices.map((office) => (
        <Circle
          key={office.id}
          center={[office.latitude, office.longitude]}
          radius={office.radiusMeters}
          pathOptions={{
            color: '#3b82f6',
            fillColor: '#3b82f6',
            fillOpacity: 0.1,
            weight: 2,
          }}
        >
          <Popup>
            <strong>{office.name}</strong>
            <br />
            Radius: {office.radiusMeters}m
          </Popup>
        </Circle>
      ))}

      {/* Check-in markers */}
      {checkIns.map((checkIn) => (
        <Marker
          key={checkIn.id}
          position={[checkIn.latitude, checkIn.longitude]}
        >
          <Popup>
            <div className="text-sm">
              <strong>{checkIn.userName}</strong>
              <br />
              {new Date(checkIn.timestamp).toLocaleString()}
              <br />
              Mode: {checkIn.workMode}
              <br />
              Status: {checkIn.verificationStatus}
            </div>
          </Popup>
        </Marker>
      ))}
    </MapContainer>
  );
}
```

Export with dynamic import wrapper for page usage.
  </action>
  <verify>Component compiles without errors</verify>
  <done>LocationMap displays markers for check-ins and circles for offices</done>
</task>

<task type="auto">
  <name>Task 4: Create Admin Map page with date filtering</name>
  <files>apps/web/src/app/admin/map/page.tsx</files>
  <action>
Create the admin map page with dynamic import to avoid SSR issues:

```tsx
'use client';

import { useState, useMemo } from 'react';
import dynamic from 'next/dynamic';
import { useCheckInLocations } from '@/hooks/useCheckInLocations';
import { useLocations } from '@/hooks/useLocations';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';

// Dynamic import to avoid SSR issues with Leaflet
const LocationMap = dynamic(
  () => import('@/components/map/LocationMap').then((mod) => mod.LocationMap),
  {
    ssr: false,
    loading: () => <Skeleton className="h-[500px] w-full rounded-lg" />
  }
);

type DateFilter = 'today' | '7days' | '30days';

export default function AdminMapPage() {
  const [dateFilter, setDateFilter] = useState<DateFilter>('today');

  const dateRange = useMemo(() => {
    const end = new Date();
    const start = new Date();

    switch (dateFilter) {
      case 'today':
        start.setHours(0, 0, 0, 0);
        break;
      case '7days':
        start.setDate(start.getDate() - 7);
        break;
      case '30days':
        start.setDate(start.getDate() - 30);
        break;
    }

    return { startDate: start, endDate: end };
  }, [dateFilter]);

  const { data: checkIns = [], isLoading: checkInsLoading } = useCheckInLocations(dateRange);
  const { data: offices = [], isLoading: officesLoading } = useLocations();

  const isLoading = checkInsLoading || officesLoading;

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Check-in Locations</h1>
        <div className="flex gap-2">
          <Button
            variant={dateFilter === 'today' ? 'default' : 'outline'}
            onClick={() => setDateFilter('today')}
          >
            Today
          </Button>
          <Button
            variant={dateFilter === '7days' ? 'default' : 'outline'}
            onClick={() => setDateFilter('7days')}
          >
            Last 7 Days
          </Button>
          <Button
            variant={dateFilter === '30days' ? 'default' : 'outline'}
            onClick={() => setDateFilter('30days')}
          >
            Last 30 Days
          </Button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Total Check-ins</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{checkIns.length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Verified</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">
              {checkIns.filter(c => c.verificationStatus === 'GeofencePassed').length}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Unverified</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">
              {checkIns.filter(c => c.verificationStatus === 'GeofenceFailed').length}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium">Office Locations</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{offices.length}</div>
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardContent className="p-0 overflow-hidden rounded-lg">
          {isLoading ? (
            <Skeleton className="h-[500px] w-full" />
          ) : (
            <LocationMap
              checkIns={checkIns}
              offices={offices.map(o => ({
                id: o.id,
                name: o.name,
                latitude: o.latitude,
                longitude: o.longitude,
                radiusMeters: o.radiusMeters,
              }))}
            />
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```

Features:
- Date filter buttons (Today, Last 7 Days, Last 30 Days)
- Summary cards showing totals
- Map with check-in markers and office geofence circles
- Loading states with skeletons
  </action>
  <verify>
1. `npm run build --workspace=apps/web` succeeds
2. Navigate to /admin/map in browser
3. Map renders with markers and circles
4. Date filter changes data
  </verify>
  <done>Admin map page shows check-in locations with geofence circles and date filtering</done>
</task>

</tasks>

<verification>
1. Apps build: `npm run build`
2. /admin/map page loads for SuperAdmin
3. Map displays with OpenStreetMap tiles
4. Office locations show as blue circles
5. Check-in markers show with popups on click
6. Date filter changes which check-ins appear
7. Summary cards show correct counts
8. Non-SuperAdmin gets 403 on API endpoint
</verification>

<success_criteria>
- Admin map page accessible at /admin/map
- Interactive map displays check-in locations
- Office geofences shown as circles with correct radius
- Markers show user name, time, verification status on click
- Date filtering works (today, 7 days, 30 days)
- Summary statistics display correctly
- SuperAdmin-only access enforced
</success_criteria>

<output>
After completion, create `.planning/phases/04-location-geofence/04-04-SUMMARY.md`
</output>
