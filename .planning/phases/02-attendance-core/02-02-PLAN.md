---
phase: 02-attendance-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/attendance/attendance.service.ts
  - apps/api/src/anomalies/anomalies.service.ts
autonomous: true

must_haves:
  truths:
    - "Break exceeding daily policy limit creates an anomaly"
    - "Anomaly is created when break ends, not during break"
    - "Anomaly includes break total and policy limit in data"
  artifacts:
    - path: "apps/api/src/attendance/attendance.service.ts"
      provides: "Break policy violation check on endBreak"
      contains: "checkBreakPolicyViolation"
  key_links:
    - from: "attendance.service.ts"
      to: "anomalies.service.ts"
      via: "dependency injection"
      pattern: "anomaliesService.create"
---

<objective>
Wire up break policy enforcement to create anomalies when daily break time exceeds policy limits.

Purpose: Per CONTEXT.md, breaks exceeding policy limits should create automatic anomalies for HR/manager review. The AnomalyType.ExcessiveBreak already exists in the schema.

Output: When endBreak() is called, if total daily break time exceeds policy, an anomaly is created automatically.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-attendance-core/02-CONTEXT.md
@apps/api/src/attendance/attendance.service.ts
@apps/api/src/anomalies/anomalies.service.ts
@apps/api/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AnomaliesService dependency to AttendanceService</name>
  <files>apps/api/src/attendance/attendance.service.ts, apps/api/src/attendance/attendance.module.ts</files>
  <action>
1. Import AnomaliesModule in attendance.module.ts (if not already)
2. Inject AnomaliesService into AttendanceService constructor
3. Add import for AnomalyType from @prisma/client

The anomalies module should already exist with basic CRUD. We just need the dependency injection set up.
  </action>
  <verify>
Run `npm run build --workspace=apps/api` - no errors about missing dependencies.
  </verify>
  <done>
AnomaliesService is injectable in AttendanceService.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement break policy violation check</name>
  <files>apps/api/src/attendance/attendance.service.ts</files>
  <action>
Add a private method `checkBreakPolicyViolation(attendanceDayId: string, userId: string, companyId: string)`:

```typescript
private async checkBreakPolicyViolation(
  attendanceDayId: string,
  userId: string,
  companyId: string
): Promise<void> {
  // 1. Get the attendance day with all breaks
  const day = await this.prisma.attendanceDay.findUnique({
    where: { id: attendanceDayId },
    include: { breaks: true },
  });

  if (!day) return;

  // 2. Calculate total break minutes (only completed breaks)
  const totalBreakMinutes = day.breaks
    .filter(b => b.endTime != null)
    .reduce((sum, b) => sum + (b.durationMinutes || 0), 0);

  // 3. Get work policy
  const policy = await this.prisma.workPolicy.findUnique({
    where: { companyId },
  });

  if (!policy) return;

  // 4. Check if exceeds limit (breakDurationMinutes + lunchDurationMinutes)
  const maxBreakMinutes = policy.breakDurationMinutes + policy.lunchDurationMinutes;

  if (totalBreakMinutes > maxBreakMinutes) {
    // 5. Check if anomaly already exists for this day
    const existingAnomaly = await this.prisma.anomalyEvent.findFirst({
      where: {
        userId,
        type: AnomalyType.ExcessiveBreak,
        detectedAt: {
          gte: day.date,
          lt: new Date(day.date.getTime() + 24 * 60 * 60 * 1000),
        },
      },
    });

    if (!existingAnomaly) {
      // 6. Find or create anomaly rule for ExcessiveBreak
      const rule = await this.prisma.anomalyRule.findFirst({
        where: {
          companyId,
          type: AnomalyType.ExcessiveBreak,
          isEnabled: true,
        },
      });

      if (rule) {
        await this.prisma.anomalyEvent.create({
          data: {
            userId,
            ruleId: rule.id,
            type: AnomalyType.ExcessiveBreak,
            severity: rule.severity,
            status: 'Open',
            title: 'Excessive Break Time',
            description: `Break time exceeded policy limit: ${totalBreakMinutes} minutes (limit: ${maxBreakMinutes} minutes)`,
            data: {
              totalBreakMinutes,
              policyLimitMinutes: maxBreakMinutes,
              date: day.date.toISOString(),
            },
          },
        });
      }
    }
  }
}
```

Call this method at the end of `endBreak()` after updating break totals.
  </action>
  <verify>
Run `npm run build --workspace=apps/api` - compilation succeeds.
  </verify>
  <done>
checkBreakPolicyViolation method exists and is called from endBreak().
  </done>
</task>

<task type="auto">
  <name>Task 3: Seed ExcessiveBreak anomaly rule</name>
  <files>apps/api/prisma/seed.ts</files>
  <action>
Check if seed.ts already creates anomaly rules. If not, add seeding for ExcessiveBreak rule:

```typescript
// In the seed function, after creating company and work policy
await prisma.anomalyRule.upsert({
  where: {
    companyId_type: {
      companyId: company.id,
      type: 'ExcessiveBreak',
    },
  },
  create: {
    companyId: company.id,
    type: 'ExcessiveBreak',
    name: 'Excessive Break Time',
    description: 'Triggered when daily break time exceeds policy limit',
    isEnabled: true,
    severity: 'Medium',
    threshold: 0, // Not used for this type
    windowDays: 1,
  },
  update: {},
});
```

Run `npx prisma db seed` to apply.
  </action>
  <verify>
1. Run `npx prisma db seed --workspace=apps/api`
2. Check database for anomaly_rules table having ExcessiveBreak type
  </verify>
  <done>
ExcessiveBreak anomaly rule exists in database.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build --workspace=apps/api`
2. Manual test:
   - Check in
   - Start break, wait, end break (simulate >75 minutes total breaks)
   - Verify anomaly created in database
3. Anomaly appears in /api/anomalies endpoint with correct data
</verification>

<success_criteria>
- Excessive break creates anomaly automatically
- Anomaly contains total break time and policy limit
- Only one anomaly per day (no duplicates)
- Rule must be enabled for anomaly to be created
</success_criteria>

<output>
After completion, create `.planning/phases/02-attendance-core/02-02-SUMMARY.md`
</output>
