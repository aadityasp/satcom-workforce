---
phase: 02-attendance-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/attendance/attendance.service.ts
  - apps/api/src/attendance/attendance.controller.ts
  - apps/api/src/attendance/dto/check-in.dto.ts
  - apps/api/src/attendance/dto/check-out.dto.ts
  - apps/api/src/attendance/dto/attendance-day.dto.ts
autonomous: true

must_haves:
  truths:
    - "API returns full attendance day context on check-in/check-out"
    - "API returns work policy limits with attendance data"
    - "Check-in validates work mode is valid enum value"
    - "Check-out auto-ends any open breaks"
  artifacts:
    - path: "apps/api/src/attendance/dto/attendance-day.dto.ts"
      provides: "Response DTO for attendance day with events, breaks, policy"
      exports: ["AttendanceDayResponseDto"]
    - path: "apps/api/src/attendance/attendance.service.ts"
      provides: "Enhanced check-in/out with full context response"
      contains: "getAttendanceDayWithPolicy"
  key_links:
    - from: "attendance.controller.ts"
      to: "AttendanceDayResponseDto"
      via: "ApiResponse decorator"
      pattern: "AttendanceDayResponseDto"
---

<objective>
Enhance attendance API endpoints to return full context needed by the frontend status card.

Purpose: The current API returns minimal data. The frontend status card needs complete attendance state including events, breaks, and work policy limits in a single response.

Output: Enhanced check-in, check-out, and today endpoints that return complete attendance context.
</objective>

<execution_context>
@/Users/adityaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adityaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-attendance-core/02-RESEARCH.md
@apps/api/src/attendance/attendance.service.ts
@apps/api/src/attendance/attendance.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AttendanceDayResponseDto</name>
  <files>apps/api/src/attendance/dto/attendance-day.dto.ts</files>
  <action>
Create a comprehensive response DTO for attendance day that includes:

```typescript
export class AttendanceDayResponseDto {
  id: string;
  date: string;

  // Current status
  status: 'not_checked_in' | 'working' | 'on_break' | 'checked_out';

  // Check-in/out info
  checkInTime: string | null;
  checkOutTime: string | null;
  workMode: WorkMode | null;

  // Current break (if on break)
  currentBreak: {
    id: string;
    type: BreakType;
    startTime: string;
  } | null;

  // Totals
  totalWorkMinutes: number;
  totalBreakMinutes: number;
  overtimeMinutes: number;

  // Events and breaks for timeline
  events: AttendanceEventDto[];
  breaks: BreakSegmentDto[];

  // Policy limits for UI indicators
  policy: {
    breakDurationMinutes: number;
    lunchDurationMinutes: number;
    overtimeThresholdMinutes: number;
  };
}
```

Use class-validator decorators for Swagger documentation. Create nested DTOs for events and breaks.
  </action>
  <verify>
Run `npm run build --workspace=apps/api` and verify no TypeScript errors.
  </verify>
  <done>
AttendanceDayResponseDto exists with all fields, nested DTOs created, exports from dto/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance AttendanceService methods</name>
  <files>apps/api/src/attendance/attendance.service.ts</files>
  <action>
Add a new private method `getAttendanceDayWithPolicy(attendanceDayId: string, companyId: string)` that:
1. Fetches the AttendanceDay with events and breaks
2. Fetches the WorkPolicy for the company
3. Computes the current status ('not_checked_in' | 'working' | 'on_break' | 'checked_out')
4. Returns data shaped as AttendanceDayResponseDto

Update `checkIn()` to:
- Return `{ event, attendanceDay: getAttendanceDayWithPolicy(...) }`

Update `checkOut()` to:
- Auto-end any open breaks (already exists - verify it works)
- Return `{ event, attendanceDay: getAttendanceDayWithPolicy(...), summary: { workedMinutes, breakMinutes, overtime } }`

Update `getToday()` to:
- Return full AttendanceDayResponseDto (or null if not checked in)
- Include policy even if no attendance day exists yet
  </action>
  <verify>
Run `npm run build --workspace=apps/api` and verify compilation succeeds.
  </verify>
  <done>
Service methods return full context including policy. Status is computed correctly based on events and breaks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update controller response types</name>
  <files>apps/api/src/attendance/attendance.controller.ts</files>
  <action>
Update the controller methods to use the new DTOs:

1. Add `@ApiOkResponse({ type: AttendanceDayResponseDto })` decorators
2. Update `checkIn()` to return the enhanced response
3. Update `checkOut()` to return enhanced response with summary
4. Update `getToday()` to return AttendanceDayResponseDto or null

Ensure Swagger documentation reflects the new response shapes.
  </action>
  <verify>
1. Run `npm run build --workspace=apps/api`
2. Start dev server and check Swagger at /api/docs - verify AttendanceDayResponseDto appears in schemas
  </verify>
  <done>
Controller uses new DTOs. Swagger shows correct response schemas for check-in, check-out, and today endpoints.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build --workspace=apps/api`
2. Tests pass: `npm run test --workspace=apps/api -- --testPathPattern=attendance`
3. Swagger documentation shows new response DTOs at /api/docs
4. Manual test: Call POST /attendance/check-in and verify response includes policy object
</verification>

<success_criteria>
- AttendanceDayResponseDto fully typed with all fields from RESEARCH.md
- check-in/check-out/today endpoints return full context
- Policy limits included in response for frontend UI indicators
- Existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-attendance-core/02-01-SUMMARY.md`
</output>
