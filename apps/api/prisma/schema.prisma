// Satcom Workforce Visibility System - Prisma Schema
// This schema defines the complete data model for the workforce management MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  Employee
  Manager
  HR
  SuperAdmin
}

enum EmployeeStatus {
  Active
  Inactive
  OnLeave
  Terminated
}

enum WorkMode {
  Office
  Remote
  CustomerSite
  FieldVisit
  Travel
}

enum AttendanceEventType {
  CheckIn
  CheckOut
}

enum BreakType {
  Break
  Lunch
}

enum VerificationStatus {
  None
  GeofencePassed
  GeofenceFailed
  QRPassed
  QRFailed
  DeviceVerified
}

enum LeaveRequestStatus {
  Pending
  Approved
  Rejected
  Cancelled
}

enum LeaveTypeCode {
  Sick
  Casual
  Earned
  WFH
  CompOff
  LOP
  FloatingHoliday
  Bereavement
  Maternity
  Paternity
  Custom
}

enum PresenceStatus {
  Online
  Away
  Offline
  Busy
}

enum ChatThreadType {
  Direct
  Group
  Project
}

enum ChatMessageType {
  Text
  VoiceNote
  File
  System
}

enum AnomalyStatus {
  Open
  Acknowledged
  Resolved
  Dismissed
}

enum AnomalySeverity {
  Low
  Medium
  High
  Critical
}

enum AnomalyType {
  RepeatedLateCheckIn
  MissingCheckOut
  ExcessiveBreak
  OvertimeSpike
  TimesheetMismatch
  GeofenceFailure
  UnusualPattern
}

enum TimesheetStatus {
  Draft
  Submitted
  Approved
  Rejected
}

enum DocumentType {
  Contract
  Policy
  Certificate
  ID
  Resume
  Training
  Report
  Other
}

enum ExpenseStatus {
  Pending
  Approved
  Rejected
  Reimbursed
}

enum ExpenseCategory {
  Travel
  Meals
  Accommodation
  Equipment
  Software
  Training
  Office
  Mileage
  Other
}

enum IntegrationType {
  QuickBooks
  Salesforce
  Slack
  GoogleCalendar
  ADP
  BambooHR
  Gusto
  Zapier
}

enum IntegrationStatus {
  Pending
  Active
  Failed
  Inactive
}

enum NotificationType {
  ShiftAssigned
  ShiftUpdated
  ShiftCancelled
  ShiftReminder
  ShiftSwapRequest
  TimeOffApproved
  TimeOffRejected
  TimeOffReminder
  TimesheetDue
  TimesheetApproved
  TimesheetRejected
  OvertimeAlert
  AnomalyDetected
  Announcement
  ChatMessage
  PresenceUpdate
  ExpenseApproved
  ExpenseRejected
  TrainingAssigned
  CertificationExpiring
  System
}

enum NotificationChannel {
  Push
  Email
  Sms
  InApp
}

enum ShiftStatus {
  Scheduled
  InProgress
  Completed
  Cancelled
  OnHold
}

enum ShiftSwapStatus {
  Pending
  Accepted
  Rejected
  Cancelled
}

enum TrainingStatus {
  Assigned
  InProgress
  Completed
  Expired
  NotStarted
}

enum CertificationStatus {
  Active
  Expired
  Revoked
  Pending
}

// =============================================================================
// COMPANY & USER MODELS
// =============================================================================

/// Company entity - single tenant for MVP
model Company {
  id        String   @id @default(uuid())
  name      String
  domain    String?
  logoUrl   String?
  timezone  String   @default("Asia/Kolkata")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  projects        Project[]
  officeLocations OfficeLocation[]
  leaveTypes      LeaveTypeConfig[]
  holidays        Holiday[]
  workPolicy      WorkPolicy?
  retentionPolicy RetentionPolicy?
  geofencePolicy  GeofencePolicy?
  anomalyRules    AnomalyRule[]
  departments         Department[]
  integrations        Integration[]
  webhooks            Webhook[]
  documentCategories  DocumentCategory[]
  expensePolicies     ExpensePolicy[]
  trainings           Training[]
  trainingCategories  TrainingCategory[]
  certifications      Certification[]

  @@map("companies")
}

/// User entity for authentication and role management
model User {
  id           String    @id @default(uuid())
  companyId    String
  email        String    @unique
  passwordHash String
  phone        String?
  role         UserRole  @default(Employee)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  company               Company              @relation(fields: [companyId], references: [id])
  profile               EmployeeProfile?
  devices               DeviceRecord[]
  refreshTokens         RefreshToken[]
  passwordResetTokens   PasswordResetToken[]
  attendanceDays        AttendanceDay[]
  timesheetEntries      TimesheetEntry[]
  leaveBalances         LeaveBalance[]
  leaveRequests         LeaveRequest[]
  approvedLeaves        LeaveRequest[]       @relation("LeaveApprover")
  presenceSession       PresenceSession?
  heartbeats            HeartbeatEvent[]
  chatMemberships       ChatMember[]
  sentMessages          ChatMessage[]
  messageStatuses       MessageStatus[]      @relation("MessageRecipient")
  anomalyEvents         AnomalyEvent[]       @relation("AnomalySubject")
  acknowledgedAnomalies AnomalyEvent[]       @relation("AnomalyAcknowledger")
  resolvedAnomalies     AnomalyEvent[]       @relation("AnomalyResolver")
  auditLogs             AuditLog[]           @relation("AuditActor")
  overriddenEvents      AttendanceEvent[]    @relation("AttendanceOverrider")
  managedProjects       Project[]            @relation("ProjectManager")
  managedEmployees      EmployeeProfile[]    @relation("EmployeeManager")
  activityLogs          ActivityLog[]
  shifts                Shift[]
  shiftSwapRequests     ShiftSwapRequest[]    @relation("SwapRequester")
  shiftSwapReceived     ShiftSwapRequest[]    @relation("SwapReceiver")
  shiftSwapApprovals    ShiftSwapRequest[]    @relation("SwapApprover")
  notifications         Notification[]
  pushTokens            PushToken[]
  notificationPrefs     NotificationPreference[]
  documents             Document[]            @relation("DocumentOwner")
  uploadedDocuments     Document[]            @relation("DocumentUploader")
  expenses              Expense[]             @relation("ExpenseOwner")
  approvedExpenses      Expense[]             @relation("ExpenseApprover")
  trainingAssignments   TrainingAssignment[]  @relation("TrainingAssignee")
  assignedTrainings     TrainingAssignment[]  @relation("TrainingAssigner")
  userCertifications    UserCertification[]   @relation("CertificationHolder")
  awardedCertifications UserCertification[]   @relation("CertificationAwarder")
  availability          UserAvailability[]

  @@index([companyId])
  @@index([email])
  @@map("users")
}

/// Employee profile with personal and work details
model EmployeeProfile {
  id           String         @id @default(uuid())
  userId       String         @unique
  employeeCode String         @unique
  firstName    String
  lastName     String
  designation  String
  department   String?
  timezone     String         @default("Asia/Kolkata")
  status       EmployeeStatus @default(Active)
  managerId    String?
  avatarUrl    String?
  joinDate     DateTime
  hourlyRate           Decimal?       @db.Decimal(10, 2)
  preferredWeeklyHours Int?
  maxWeeklyHours       Int?
  seniorityLevel       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  manager User? @relation("EmployeeManager", fields: [managerId], references: [id])

  @@index([employeeCode])
  @@index([managerId])
  @@map("employee_profiles")
}

/// Device records for verified devices (OTP verification)
model DeviceRecord {
  id          String   @id @default(uuid())
  userId      String
  fingerprint String
  deviceName  String
  platform    String
  isVerified  Boolean  @default(false)
  lastUsedAt  DateTime
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@map("device_records")
}

/// Refresh tokens for session management
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

/// Password reset tokens
model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// =============================================================================
// PROJECT & TASK MODELS
// =============================================================================

/// Projects for timesheet categorization
model Project {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  code        String   @unique
  description String?
  isActive    Boolean  @default(true)
  managerId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company          Company          @relation(fields: [companyId], references: [id])
  manager          User?            @relation("ProjectManager", fields: [managerId], references: [id])
  tasks            Task[]
  timesheetEntries TimesheetEntry[]
  chatThreads      ChatThread[]
  activityLogs     ActivityLog[]
  expenses         Expense[]

  @@index([companyId])
  @@index([code])
  @@map("projects")
}

/// Tasks within projects
model Task {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  code        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project          Project          @relation(fields: [projectId], references: [id])
  timesheetEntries TimesheetEntry[]
  activityLogs     ActivityLog[]

  @@unique([projectId, code])
  @@index([projectId])
  @@map("tasks")
}

// =============================================================================
// ATTENDANCE MODELS
// =============================================================================

/// Daily attendance record per user
model AttendanceDay {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date
  totalWorkMinutes  Int      @default(0)
  totalBreakMinutes Int      @default(0)
  totalLunchMinutes Int      @default(0)
  overtimeMinutes   Int      @default(0)
  isComplete        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user   User              @relation(fields: [userId], references: [id])
  events AttendanceEvent[]
  breaks BreakSegment[]

  @@unique([userId, date])
  @@index([userId, date])
  @@map("attendance_days")
}

/// Check-in and check-out events
model AttendanceEvent {
  id                 String              @id @default(uuid())
  attendanceDayId    String
  type               AttendanceEventType
  timestamp          DateTime
  workMode           WorkMode
  latitude           Decimal?            @db.Decimal(10, 8)
  longitude          Decimal?            @db.Decimal(11, 8)
  verificationStatus VerificationStatus  @default(None)
  deviceFingerprint  String?
  notes              String?
  isOverride         Boolean             @default(false)
  overrideReason     String?
  overrideBy         String?
  createdAt          DateTime            @default(now())

  // Relations
  attendanceDay AttendanceDay @relation(fields: [attendanceDayId], references: [id], onDelete: Cascade)
  overrider     User?         @relation("AttendanceOverrider", fields: [overrideBy], references: [id])

  @@index([attendanceDayId])
  @@index([timestamp])
  @@map("attendance_events")
}

/// Break and lunch segments
model BreakSegment {
  id              String    @id @default(uuid())
  attendanceDayId String
  type            BreakType
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  attendanceDay AttendanceDay @relation(fields: [attendanceDayId], references: [id], onDelete: Cascade)

  @@index([attendanceDayId])
  @@map("break_segments")
}

// =============================================================================
// TIMESHEET MODELS
// =============================================================================

/// Manual time tracking entries
model TimesheetEntry {
  id        String          @id @default(uuid())
  userId    String
  date      DateTime        @db.Date
  projectId String
  taskId    String
  minutes   Int
  notes     String?
  status    TimesheetStatus @default(Draft)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  user        User                  @relation(fields: [userId], references: [id])
  project     Project               @relation(fields: [projectId], references: [id])
  task        Task                  @relation(fields: [taskId], references: [id])
  attachments TimesheetAttachment[]

  @@index([userId, date])
  @@index([projectId])
  @@map("timesheet_entries")
}

/// File attachments for timesheets
model TimesheetAttachment {
  id               String   @id @default(uuid())
  timesheetEntryId String
  fileName         String
  fileUrl          String
  fileType         String
  fileSize         Int
  createdAt        DateTime @default(now())

  // Relations
  timesheetEntry TimesheetEntry @relation(fields: [timesheetEntryId], references: [id], onDelete: Cascade)

  @@index([timesheetEntryId])
  @@map("timesheet_attachments")
}

// =============================================================================
// LEAVE MODELS
// =============================================================================

/// Leave type definitions
model LeaveTypeConfig {
  id               String        @id @default(uuid())
  companyId        String
  name             String
  code             LeaveTypeCode
  description      String?
  defaultDays      Int
  carryForward     Boolean       @default(false)
  maxCarryForward  Int           @default(0)
  requiresApproval Boolean       @default(true)
  isPaid           Boolean       @default(true)
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  company       Company        @relation(fields: [companyId], references: [id])
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("leave_type_configs")
}

/// Per-user leave balances
model LeaveBalance {
  id          String   @id @default(uuid())
  userId      String
  leaveTypeId String
  year        Int
  allocated   Decimal  @db.Decimal(4, 1)
  used        Decimal  @default(0) @db.Decimal(4, 1)
  pending     Decimal  @default(0) @db.Decimal(4, 1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User            @relation(fields: [userId], references: [id])
  leaveType LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])

  @@unique([userId, leaveTypeId, year])
  @@index([userId, year])
  @@map("leave_balances")
}

/// Leave applications
model LeaveRequest {
  id              String             @id @default(uuid())
  userId          String
  leaveTypeId     String
  startDate       DateTime           @db.Date
  endDate         DateTime           @db.Date
  totalDays       Decimal            @db.Decimal(4, 1)
  reason          String
  status          LeaveRequestStatus @default(Pending)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  user      User            @relation(fields: [userId], references: [id])
  leaveType LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])
  approver  User?           @relation("LeaveApprover", fields: [approvedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@map("leave_requests")
}

/// Company holiday calendar
model Holiday {
  id         String   @id @default(uuid())
  companyId  String
  name       String
  date       DateTime @db.Date
  isOptional Boolean  @default(false)
  year       Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, date])
  @@index([companyId, year])
  @@map("holidays")
}

// =============================================================================
// PRESENCE MODELS
// =============================================================================

/// User presence session
model PresenceSession {
  id               String         @id @default(uuid())
  userId           String         @unique
  status           PresenceStatus @default(Offline)
  lastSeenAt       DateTime       @default(now())
  currentWorkMode  WorkMode?
  currentProjectId String?
  currentTaskId    String?
  statusMessage    String? // ACTV-02: User's current status text
  statusUpdatedAt  DateTime? // When status message was last set
  lastLatitude     Decimal?       @db.Decimal(10, 8) // ACTV-06: GPS latitude
  lastLongitude    Decimal?       @db.Decimal(11, 8) // ACTV-06: GPS longitude
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("presence_sessions")
}

/// Heartbeat events for presence tracking
model HeartbeatEvent {
  id        String   @id @default(uuid())
  userId    String
  timestamp DateTime @default(now())
  projectId String?
  taskId    String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@map("heartbeat_events")
}

/// Activity log for tracking time spent on projects/tasks (ACTV-04)
model ActivityLog {
  id        String    @id @default(uuid())
  userId    String
  projectId String?
  taskId    String?
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])
  task    Task?    @relation(fields: [taskId], references: [id])

  @@index([userId, startedAt])
  @@map("activity_logs")
}

// =============================================================================
// CHAT MODELS
// =============================================================================

/// Chat conversation threads
model ChatThread {
  id            String         @id @default(uuid())
  type          ChatThreadType
  name          String?
  projectId     String?
  lastMessageAt DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  project  Project?      @relation(fields: [projectId], references: [id])
  members  ChatMember[]
  messages ChatMessage[]

  @@index([type])
  @@index([projectId])
  @@map("chat_threads")
}

/// Thread membership
model ChatMember {
  id          String    @id @default(uuid())
  threadId    String
  userId      String
  joinedAt    DateTime  @default(now())
  lastReadAt  DateTime?
  unreadCount Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id])

  @@unique([threadId, userId])
  @@index([userId])
  @@map("chat_members")
}

/// Individual messages
model ChatMessage {
  id              String          @id @default(uuid())
  threadId        String
  senderId        String
  type            ChatMessageType
  content         String?
  attachmentUrl   String?
  attachmentType  String?
  durationSeconds Int?
  isEdited        Boolean         @default(false)
  editedAt        DateTime?
  deletedAt       DateTime?
  createdAt       DateTime        @default(now())

  // Relations
  thread   ChatThread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender   User            @relation(fields: [senderId], references: [id])
  statuses MessageStatus[]

  @@index([threadId, createdAt])
  @@index([senderId])
  @@map("chat_messages")
}

/// Per-recipient message status for delivery/read tracking
model MessageStatus {
  id          String    @id @default(uuid())
  messageId   String
  userId      String // Recipient user
  deliveredAt DateTime?
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation("MessageRecipient", fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([userId])
  @@map("message_statuses")
}

// =============================================================================
// GEOFENCE MODELS
// =============================================================================

/// Office locations for geofencing
model OfficeLocation {
  id           String   @id @default(uuid())
  companyId    String
  name         String
  address      String
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  radiusMeters Int
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id])
  shifts         Shift[]
  shiftTemplates ShiftTemplate[]

  @@index([companyId])
  @@map("office_locations")
}

/// Geofence policy settings
model GeofencePolicy {
  id                       String   @id @default(uuid())
  companyId                String   @unique
  isEnabled                Boolean  @default(false)
  requireGeofenceForOffice Boolean  @default(false)
  allowBypassWithReason    Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@map("geofence_policies")
}

// =============================================================================
// ANOMALY MODELS
// =============================================================================

/// Anomaly detection rule configuration
model AnomalyRule {
  id          String          @id @default(uuid())
  companyId   String
  type        AnomalyType
  name        String
  description String
  isEnabled   Boolean         @default(true)
  severity    AnomalySeverity
  threshold   Int
  windowDays  Int
  config      Json            @default("{}")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  company Company        @relation(fields: [companyId], references: [id])
  events  AnomalyEvent[]

  @@unique([companyId, type])
  @@index([companyId])
  @@map("anomaly_rules")
}

/// Detected anomaly events
model AnomalyEvent {
  id              String          @id @default(uuid())
  userId          String
  ruleId          String
  type            AnomalyType
  severity        AnomalySeverity
  status          AnomalyStatus   @default(Open)
  title           String
  description     String
  data            Json
  detectedAt      DateTime        @default(now())
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  user         User        @relation("AnomalySubject", fields: [userId], references: [id])
  rule         AnomalyRule @relation(fields: [ruleId], references: [id])
  acknowledger User?       @relation("AnomalyAcknowledger", fields: [acknowledgedBy], references: [id])
  resolver     User?       @relation("AnomalyResolver", fields: [resolvedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@index([detectedAt])
  @@map("anomaly_events")
}

// =============================================================================
// POLICY MODELS
// =============================================================================

/// Work hours and rules policy
model WorkPolicy {
  id                        String   @id @default(uuid())
  companyId                 String   @unique
  standardWorkHours         Int      @default(8)
  maxWorkHours              Int      @default(12)
  overtimeThresholdMinutes  Int      @default(480)
  maxOvertimeMinutes        Int      @default(240)
  breakDurationMinutes      Int      @default(15)
  lunchDurationMinutes      Int      @default(60)
  graceMinutesLate          Int      @default(15)
  graceMinutesEarly         Int      @default(15)
  requireTimesheetNotes     Boolean  @default(false)
  maxTimesheetMinutesPerDay Int      @default(1440)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@map("work_policies")
}

/// Data retention policy settings
model RetentionPolicy {
  id                      String   @id @default(uuid())
  companyId               String   @unique
  chatRetentionDays       Int      @default(365)
  attachmentRetentionDays Int      @default(365)
  anomalyRetentionDays    Int      @default(730)
  auditLogRetentionDays   Int      @default(2555)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id])

  @@map("retention_policies")
}

// =============================================================================
// AUDIT MODELS
// =============================================================================

/// Audit log for tracking sensitive actions
model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  action     String
  entityType String
  entityId   String
  before     Json?
  after      Json?
  reason     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  actor User @relation("AuditActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// SCHEDULING MODELS
// =============================================================================

model Department {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company        Company         @relation(fields: [companyId], references: [id])
  shifts         Shift[]
  shiftTemplates ShiftTemplate[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("departments")
}

model Shift {
  id            String      @id @default(uuid())
  userId        String
  companyId     String
  startTime     DateTime
  endTime       DateTime
  status        ShiftStatus @default(Scheduled)
  locationId    String?
  departmentId  String?
  notes         String?
  breakDuration Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user       User            @relation(fields: [userId], references: [id])
  location   OfficeLocation? @relation(fields: [locationId], references: [id])
  department Department?     @relation(fields: [departmentId], references: [id])
  swapRequests ShiftSwapRequest[]

  @@index([userId])
  @@index([companyId])
  @@index([startTime, endTime])
  @@map("shifts")
}

model ShiftTemplate {
  id            String   @id @default(uuid())
  companyId     String
  name          String
  startTime     String
  endTime       String
  breakDuration Int      @default(0)
  departmentId  String?
  locationId    String?
  daysOfWeek    Int[]
  createdBy     String?
  updatedBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  department Department?     @relation(fields: [departmentId], references: [id])
  location   OfficeLocation? @relation(fields: [locationId], references: [id])

  @@index([companyId])
  @@map("shift_templates")
}

model ShiftSwapRequest {
  id              String          @id @default(uuid())
  shiftId         String
  requestedById   String
  requestedToId   String
  status          ShiftSwapStatus @default(Pending)
  reason          String?
  respondedAt     DateTime?
  respondReason   String?
  approvedById    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  shift       Shift @relation(fields: [shiftId], references: [id])
  requestedBy User  @relation("SwapRequester", fields: [requestedById], references: [id])
  requestedTo User  @relation("SwapReceiver", fields: [requestedToId], references: [id])
  approvedBy  User? @relation("SwapApprover", fields: [approvedById], references: [id])

  @@index([shiftId])
  @@index([requestedById])
  @@index([requestedToId])
  @@map("shift_swap_requests")
}

model UserAvailability {
  id          String  @id @default(uuid())
  userId      String
  dayOfWeek   Int
  startTime   String
  endTime     String
  isPreferred Boolean @default(false)
  isAvailable Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_availability")
}

// =============================================================================
// NOTIFICATION MODELS
// =============================================================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  priority  String           @default("normal")
  actionUrl String?
  imageUrl  String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String
  token     String
  platform  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@map("push_tokens")
}

model NotificationPreference {
  id      String              @id @default(uuid())
  userId  String
  channel NotificationChannel
  enabled Boolean             @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel])
  @@index([userId])
  @@map("notification_preferences")
}

// =============================================================================
// DOCUMENT MODELS
// =============================================================================

model DocumentCategory {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id])
  documents Document[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("document_categories")
}

model Document {
  id             String       @id @default(uuid())
  companyId      String
  title          String
  description    String?
  type           DocumentType
  categoryId     String?
  userId         String
  fileUrl        String
  fileName       String
  fileSize       Int
  fileType       String
  uploadedBy     String
  expiresAt      DateTime?
  isConfidential Boolean      @default(false)
  version        Int          @default(1)
  updatedBy      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  category       DocumentCategory? @relation(fields: [categoryId], references: [id])
  user           User              @relation("DocumentOwner", fields: [userId], references: [id])
  uploadedByUser User              @relation("DocumentUploader", fields: [uploadedBy], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([type])
  @@map("documents")
}

// =============================================================================
// EXPENSE MODELS
// =============================================================================

model Expense {
  id                     String          @id @default(uuid())
  userId                 String
  companyId              String
  category               ExpenseCategory
  amount                 Decimal         @db.Decimal(10, 2)
  currency               String          @default("USD")
  date                   DateTime        @db.Date
  description            String
  receiptUrl             String?
  projectId              String?
  mileage                Decimal?        @db.Decimal(10, 2)
  status                 ExpenseStatus   @default(Pending)
  approvedBy             String?
  approvedAt             DateTime?
  approvalNotes          String?
  rejectionReason        String?
  reimbursedAt           DateTime?
  reimbursementMethod    String?
  reimbursementReference String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  user           User     @relation("ExpenseOwner", fields: [userId], references: [id])
  approvedByUser User?    @relation("ExpenseApprover", fields: [approvedBy], references: [id])
  project        Project? @relation(fields: [projectId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@map("expenses")
}

model ExpensePolicy {
  id               String          @id @default(uuid())
  companyId        String
  category         ExpenseCategory
  maxAmount        Decimal         @db.Decimal(10, 2)
  requiresReceipt  Boolean         @default(true)
  receiptThreshold Decimal?        @db.Decimal(10, 2)
  notes            String?
  createdBy        String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, category])
  @@index([companyId])
  @@map("expense_policies")
}

// =============================================================================
// INTEGRATION MODELS
// =============================================================================

model Integration {
  id           String            @id @default(uuid())
  companyId    String
  type         IntegrationType
  name         String
  config       Json              @default("{}")
  status       IntegrationStatus @default(Pending)
  errorMessage String?
  lastSyncAt   DateTime?
  createdBy    String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("integrations")
}

model Webhook {
  id        String   @id @default(uuid())
  companyId String
  url       String
  events    String[]
  secret    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company    Company            @relation(fields: [companyId], references: [id])
  deliveries WebhookDelivery[]

  @@index([companyId])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String   @id @default(uuid())
  webhookId    String
  eventId      String?
  eventType    String
  payload      Json
  statusCode   Int?
  success      Boolean
  responseBody String?
  createdAt    DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@map("webhook_deliveries")
}

// =============================================================================
// TRAINING MODELS
// =============================================================================

model TrainingCategory {
  id          String   @id @default(uuid())
  companyId   String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company    @relation(fields: [companyId], references: [id])
  trainings Training[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("training_categories")
}

model Training {
  id               String   @id @default(uuid())
  companyId        String
  title            String
  description      String?
  categoryId       String?
  duration         Int?
  requiredForRoles String[]
  recurrenceMonths Int?
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company        Company            @relation(fields: [companyId], references: [id])
  category       TrainingCategory?  @relation(fields: [categoryId], references: [id])
  assignments    TrainingAssignment[]
  certifications Certification[]

  @@index([companyId])
  @@map("trainings")
}

model TrainingAssignment {
  id          String         @id @default(uuid())
  trainingId  String
  userId      String
  status      TrainingStatus @default(Assigned)
  assignedBy  String?
  dueDate     DateTime?
  progress    Int            @default(0)
  completedAt DateTime?
  notes       String?
  assignedAt  DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  training   Training @relation(fields: [trainingId], references: [id])
  user       User     @relation("TrainingAssignee", fields: [userId], references: [id])
  assigner   User?    @relation("TrainingAssigner", fields: [assignedBy], references: [id])

  @@index([trainingId])
  @@index([userId])
  @@index([status])
  @@map("training_assignments")
}

model Certification {
  id                 String   @id @default(uuid())
  companyId          String
  name               String
  description        String?
  issuingBody        String?
  validityMonths     Int?
  requiredTrainingId String?
  createdBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  company            Company             @relation(fields: [companyId], references: [id])
  requiredTraining   Training?           @relation(fields: [requiredTrainingId], references: [id])
  userCertifications UserCertification[]

  @@index([companyId])
  @@map("certifications")
}

model UserCertification {
  id              String              @id @default(uuid())
  certificationId String
  userId          String
  issuedDate      DateTime
  expiryDate      DateTime?
  certificateUrl  String?
  status          CertificationStatus @default(Active)
  awardedBy       String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  certification Certification @relation(fields: [certificationId], references: [id])
  user          User          @relation("CertificationHolder", fields: [userId], references: [id])
  awarder       User?         @relation("CertificationAwarder", fields: [awardedBy], references: [id])

  @@index([certificationId])
  @@index([userId])
  @@map("user_certifications")
}
